<%# SEO Meta Tags %>
<% page_title @event.title %>
<% page_description @event.description %>
<% og_type 'event' %>
<% canonical_url event_url(@event) %>
<% if @event.banner_image.attached? %>
  <% og_image url_for(@event.banner_image) %>
<% end %>

<%# RSS Feed for this event %>
<% content_for :head do %>
  <%= auto_discovery_link_tag :rss, rss_event_path(@event, format: :rss), title: "#{@event.title} RSS Feed" %>
<% end %>

<%# JSON-LD Structured Data for Event %>
<% content_for :json_ld do %>
  <script type="application/ld+json"><%= event_json_ld(@event) %></script>
  <script type="application/ld+json"><%= breadcrumb_json_ld([
    { name: 'Home', url: root_url },
    { name: 'Events', url: events_url },
    { name: @event.title, url: event_url(@event) }
  ]) %></script>
<% end %>

<article class="row" itemscope itemtype="https://schema.org/Event">
  <div class="col-lg-8">
    <% if @event.banner_image.attached? %>
      <figure class="mb-4 event-banner">
        <%= image_tag @event.banner_image, class: "img-fluid rounded", style: "width: 100%; max-height: 400px; object-fit: cover;", alt: "Banner image for #{@event.title}", loading: "lazy", itemprop: "image" %>
      </figure>
    <% end %>
    
    <header class="d-flex justify-content-between align-items-start mb-3">
      <h1 itemprop="name"><%= @event.title %></h1>
      <div role="status" aria-live="polite">
        <% if @event.draft? %>
          <span class="badge bg-secondary fs-5 me-2">
            <i class="bi bi-file-earmark-text" aria-hidden="true"></i> Draft
          </span>
        <% end %>
        <% if @event.status != 'active' %>
          <span class="badge bg-<%= @event.status == 'postponed' ? 'warning' : 'danger' %> fs-5">
            <%= @event.status.titleize %>
          </span>
        <% end %>
      </div>
    </header>

    <% if @event.status == 'postponed' && @event.postponed_until %>
      <div class="alert alert-warning" role="alert">
        <h2 class="alert-heading h5">
          <i class="bi bi-clock-history" aria-hidden="true"></i> Event Postponed
        </h2>
        <p class="mb-0"><strong>Rescheduled to:</strong> <%= @event.postponed_until.strftime('%B %d, %Y at %I:%M %p') %></p>
        <% if @event.cancellation_reason.present? %>
          <hr>
          <p class="mb-0"><strong>Reason:</strong> <%= @event.cancellation_reason %></p>
        <% end %>
      </div>
    <% elsif @event.status == 'cancelled' %>
      <div class="alert alert-danger" role="alert">
        <h2 class="alert-heading h5">
          <i class="bi bi-x-circle" aria-hidden="true"></i> Event Cancelled
        </h2>
        <% if @event.cancellation_reason.present? %>
          <p class="mb-0"><strong>Reason:</strong> <%= @event.cancellation_reason %></p>
        <% else %>
          <p class="mb-0">This event has been cancelled.</p>
        <% end %>
      </div>
    <% end %>

    <section class="card mb-4">
      <div class="card-body">
        <h2 class="card-title h5">Description</h2>
        <div class="card-text" itemprop="description"><%= simple_format(@event.description) %></div>
        
        <% if @event.more_info_url.present? %>
          <div class="mt-3">
            <%= link_to sanitize(@event.more_info_url), target: "_blank", rel: "noopener noreferrer", class: "btn btn-outline-primary" do %>
              <i class="bi bi-box-arrow-up-right"></i> Learn More About This Event
            <% end %>
          </div>
        <% end %>
      </div>
    </section>

    <% if @event.occurrences.upcoming.any? %>
      <section class="card mb-4">
        <div class="card-body">
          <h2 class="card-title h5">Upcoming Occurrences</h2>
          <div class="list-group list-group-flush">
            <% @event.occurrences.upcoming.limit(10).each do |occurrence| %>
              <div class="list-group-item d-flex justify-content-between align-items-center">
                <div>
                  <%= occurrence.occurs_at.strftime('%A, %B %d, %Y at %I:%M %p') %>
                  <% if occurrence.status == 'postponed' && occurrence.postponed_until %>
                    <%
                      new_occurrence = occurrence.event.occurrences.find_by(
                        occurs_at: occurrence.postponed_until,
                        status: 'active'
                      )
                    %>
                    <% if new_occurrence %>
                      <%= link_to event_occurrence_path(new_occurrence), class: "badge bg-warning text-dark ms-2 text-decoration-none" do %>
                        Postponed to <%= occurrence.postponed_until.strftime('%B %d at %I:%M %p') %>
                      <% end %>
                    <% else %>
                      <span class="badge bg-warning text-dark ms-2">
                        Postponed to <%= occurrence.postponed_until.strftime('%B %d at %I:%M %p') %>
                      </span>
                    <% end %>
                  <% elsif occurrence.status == 'cancelled' %>
                    <span class="badge bg-danger ms-2">
                      Cancelled
                    </span>
                  <% end %>
                </div>
                <% if user_signed_in? && @event.hosted_by?(current_user) %>
                  <div class="btn-group btn-group-sm">
                    <%= link_to "View", event_occurrence_path(occurrence), class: "btn btn-outline-primary" %>
                  </div>
                <% end %>
              </div>
            <% end %>
          </div>
        </div>
      </section>
    <% end %>

    <%= render 'journal', event: @event %>
  </div>

  <aside class="col-lg-4">
    <section class="card mb-3">
      <div class="card-body">
        <h2 class="card-title h5">Event Details</h2>
        <dl class="row mb-0">
          <dt class="col-sm-5">Date:</dt>
          <dd class="col-sm-7"><%= @event.start_time.strftime('%B %d, %Y') %></dd>

          <% postponed_occurrences = @event.occurrences.where(status: 'postponed').where.not(postponed_until: nil) %>
          <% if postponed_occurrences.any? %>
            <dt class="col-sm-5">Postponed:</dt>
            <dd class="col-sm-7">
              <% postponed_occurrences.each do |occurrence| %>
                <%
                  new_occurrence = occurrence.event.occurrences.find_by(
                    occurs_at: occurrence.postponed_until,
                    status: 'active'
                  )
                %>
                <div class="mb-2">
                  <span class="text-warning fw-bold">
                    <%= occurrence.occurs_at.strftime('%B %d') %>
                  </span>
                  <% if new_occurrence %>
                    <%= link_to event_occurrence_path(new_occurrence), class: "badge bg-warning text-dark text-decoration-none ms-2" do %>
                      <i class="bi bi-arrow-right"></i> <%= occurrence.postponed_until.strftime('%B %d at %I:%M %p') %>
                    <% end %>
                  <% else %>
                    <span class="badge bg-warning text-dark ms-2">
                      <i class="bi bi-arrow-right"></i> <%= occurrence.postponed_until.strftime('%B %d at %I:%M %p') %>
                    </span>
                  <% end %>
                </div>
              <% end %>
            </dd>
          <% end %>

          <dt class="col-sm-5">Time:</dt>
          <dd class="col-sm-7"><%= @event.start_time.strftime('%I:%M %p') %> to <%= (@event.start_time + @event.duration.minutes).strftime('%I:%M %p') %></dd>

          <% if @event.hosts.any? %>
            <dt class="col-sm-5">Hosts:</dt>
            <dd class="col-sm-7">
              <% @event.hosts.each do |host| %>
                <div class="d-flex justify-content-between align-items-center mb-1">
                  <span>
                    <%= host.name || host.email %>
                  </span>
                  <% if user_signed_in? && (current_user.admin? || @event.hosted_by?(current_user)) %>
                    <% can_remove = @event.hosts.count > 1 %>
                    <%= button_to event_event_host_path(@event, host),
                        method: :delete,
                        class: "btn btn-sm btn-outline-danger #{can_remove ? '' : 'disabled'}",
                        disabled: !can_remove,
                        form: { style: "display: inline;", data: { turbo_confirm: can_remove ? "Remove #{host.name || host.email} as a host?" : nil } },
                        title: can_remove ? nil : "Cannot remove the only host",
                        "aria-label": "Remove #{host.name || host.email} as host" do %>
                      <i class="bi bi-x" aria-hidden="true"></i>
                      <span class="visually-hidden">Remove host</span>
                    <% end %>
                  <% end %>
                </div>
              <% end %>
            </dd>
          <% end %>

          <dt class="col-sm-5">Recurrence:</dt>
          <dd class="col-sm-7"><%= @event.recurrence_type.titleize %></dd>

          <% if @event.location.present? %>
            <dt class="col-sm-5"><i class="bi bi-geo-alt-fill" aria-hidden="true"></i> Location:</dt>
            <dd class="col-sm-7">
              <%= @event.location.name %>
              <% if @event.location.description.present? %>
                <br>
                <small class="text-muted"><%= @event.location.description %></small>
              <% end %>
            </dd>
          <% end %>

          <dt class="col-sm-5">Open To:</dt>
          <dd class="col-sm-7">
            <% 
              open_to_label = case @event.open_to
              when 'public' then 'Everyone'
              when 'members' then 'Members Only'
              when 'private' then 'Private'
              else @event.open_to&.titleize
              end
              open_to_icon = @event.open_to == 'public' ? 'door-open' : (@event.open_to == 'members' ? 'people-fill' : 'envelope')
            %>
            <i class="bi bi-<%= open_to_icon %>" aria-hidden="true"></i> <%= open_to_label %>
          </dd>

          <dt class="col-sm-5">Status:</dt>
          <dd class="col-sm-7"><%= @event.status.titleize %></dd>

          <% if @event.requires_mask %>
            <dt class="col-sm-5">Safety:</dt>
            <dd class="col-sm-7">
              <span class="badge bg-info">
                <i class="bi bi-shield-fill-check" aria-hidden="true"></i> Masks Required
              </span>
            </dd>
          <% end %>
        </dl>
      </div>
    </section>

    <% next_occurrence = @event.occurrences.upcoming.first %>
    <% if next_occurrence %>
      <section class="card mb-3">
        <div class="card-body">
          <h2 class="card-title h5">Add to Calendar</h2>
          <p class="card-text small text-muted">Add the next occurrence (<%= next_occurrence.occurs_at.strftime('%b %d') %>) to your calendar</p>
          <div class="d-grid gap-2">
            <%= link_to google_calendar_url(next_occurrence), target: "_blank", rel: "noopener", class: "btn btn-outline-primary", "aria-label": "Add to Google Calendar" do %>
              <i class="bi bi-google" aria-hidden="true"></i> Google Calendar
            <% end %>
            <%= link_to apple_calendar_url(next_occurrence), class: "btn btn-outline-dark", "aria-label": "Add to Apple Calendar (downloads .ics file)" do %>
              <i class="bi bi-apple" aria-hidden="true"></i> Apple Calendar
            <% end %>
            <%= link_to outlook_calendar_url(next_occurrence), target: "_blank", rel: "noopener", class: "btn btn-outline-primary", "aria-label": "Add to Outlook.com Calendar" do %>
              <i class="bi bi-microsoft" aria-hidden="true"></i> Outlook.com
            <% end %>
            <div class="btn-group" role="group">
              <%= link_to office365_calendar_url(next_occurrence), target: "_blank", rel: "noopener", class: "btn btn-outline-secondary btn-sm", "aria-label": "Add to Office 365 Calendar" do %>
                <i class="bi bi-building" aria-hidden="true"></i> Office 365
              <% end %>
              <%= link_to yahoo_calendar_url(next_occurrence), target: "_blank", rel: "noopener", class: "btn btn-outline-secondary btn-sm", "aria-label": "Add to Yahoo Calendar" do %>
                <i class="bi bi-calendar-plus" aria-hidden="true"></i> Yahoo
              <% end %>
            </div>
          </div>
        </div>
      </section>
    <% end %>

    <section class="card mb-3">
      <div class="card-body">
        <h2 class="card-title h5">Subscribe</h2>
        <p class="card-text small text-muted">Subscribe to all occurrences of this event</p>
        <%= link_to event_ical_path(@event.ical_token, format: :ics), class: "btn btn-primary w-100 mb-2", "aria-label": "Subscribe to #{@event.title} calendar feed" do %>
          <i class="bi bi-calendar-plus" aria-hidden="true"></i> iCal Feed
        <% end %>
        <%= link_to rss_event_path(@event, format: :rss), class: "btn btn-outline-warning w-100", "aria-label": "RSS feed for #{@event.title}" do %>
          <i class="bi bi-rss" aria-hidden="true"></i> RSS Feed
        <% end %>
      </div>
    </section>

    <section class="card mb-3">
      <div class="card-body">
        <h2 class="card-title h5">Embed Calendar</h2>
        <p class="card-text small text-muted">Embed this event's calendar on your website</p>
        <div class="mb-2">
          <%= link_to "Preview Embed", embed_event_path(@event), class: "btn btn-sm btn-outline-primary w-100", target: "_blank" %>
        </div>
        <div class="mt-3">
          <label class="form-label small fw-bold">Embed Code:</label>
          <textarea class="form-control font-monospace small" rows="3" readonly onclick="this.select()"><iframe src="<%= embed_event_url(@event) %>" width="100%" height="600" frameborder="0" style="border: 1px solid #dee2e6; border-radius: 0.25rem;"></iframe></textarea>
          <small class="form-text text-muted">Copy and paste this code into your website</small>
        </div>
      </div>
    </section>

    <% if user_signed_in? && (current_user.admin? || @event.hosted_by?(current_user)) %>
      <section class="card mb-3">
        <div class="card-body">
          <h2 class="card-title h5">Invite Co-Host</h2>
          <%= form_with url: event_event_hosts_path(@event), method: :post, local: true do |f| %>
            <div class="mb-3">
              <label for="user_id" class="form-label">Select User</label>
              <%= select_tag :user_id, 
                  options_from_collection_for_select(
                    User.where.not(id: @event.hosts.pluck(:id)).order(:name, :email), 
                    :id, 
                    ->(u) { u.name || u.email }
                  ),
                  class: "form-select",
                  prompt: "Choose a user to add as host..." %>
            </div>
            <%= f.submit "Add as Co-Host", class: "btn btn-primary w-100" %>
          <% end %>
        </div>
      </section>

      <section class="card">
        <div class="card-body">
          <h2 class="card-title h5">Manage Event</h2>
          <div class="d-grid gap-2">
            <%= link_to "Edit", edit_event_path(@event), class: "btn btn-warning" %>
            
            <% if @event.status == 'active' %>
              <% if @event.occurrences.count == 1 %>
                <button type="button" class="btn btn-outline-warning" data-bs-toggle="modal" data-bs-target="#postponeModal">
                  Postpone Occurrence
                </button>
              <% end %>
              <button type="button" class="btn btn-outline-danger" data-bs-toggle="modal" data-bs-target="#cancelModal">
                Cancel Event
              </button>
            <% else %>
              <%= button_to "Reactivate", reactivate_event_path(@event), 
                  method: :post, 
                  class: "btn btn-success" %>
            <% end %>
            
            <%= button_to "Delete", event_path(@event), 
                method: :delete, 
                class: "btn btn-danger",
                form: { data: { turbo_confirm: "Are you sure you want to delete this event? This cannot be undone." } } %>
          </div>
        </div>
      </section>
    <% end %>
  </aside>
</article>

<nav class="mt-3" aria-label="Back navigation">
  <%= link_to "â† Back to Events", events_path, class: "btn btn-secondary" %>
</nav>

<!-- Postpone Modal (for single-occurrence events) -->
<% if @event.occurrences.count == 1 %>
  <% single_occurrence = @event.occurrences.first %>
  <div class="modal fade" id="postponeModal" tabindex="-1" aria-labelledby="postponeModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <%= form_with url: postpone_event_occurrence_path(single_occurrence), method: :post do |f| %>
          <div class="modal-header">
            <h5 class="modal-title" id="postponeModalLabel">Postpone Occurrence</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <div class="alert alert-info">
              <small>This will mark the current occurrence as postponed and create a new occurrence at the rescheduled date.</small>
            </div>
            <div class="mb-3">
              <label for="postponed_until" class="form-label">Postpone Until</label>
              <input type="datetime-local" 
                     class="form-control" 
                     id="postponed_until" 
                     name="postponed_until"
                     value="<%= 1.week.from_now.strftime('%Y-%m-%dT%H:%M') %>">
              <small class="form-text text-muted">Select when the occurrence should be rescheduled to</small>
            </div>
            <div class="mb-3">
              <label for="postpone_reason" class="form-label">Reason (Optional)</label>
              <textarea class="form-control" 
                        id="postpone_reason" 
                        name="reason" 
                        rows="3" 
                        placeholder="e.g., Equipment maintenance, low registrations, scheduling conflict..."></textarea>
              <small class="form-text text-muted">This will be visible to users viewing the occurrence</small>
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
            <%= f.submit "Postpone Occurrence", class: "btn btn-warning" %>
          </div>
        <% end %>
      </div>
    </div>
  </div>
<% end %>

<!-- Cancel Modal -->
<div class="modal fade" id="cancelModal" tabindex="-1" aria-labelledby="cancelModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <%= form_with url: cancel_event_path(@event), method: :post do |f| %>
        <div class="modal-header bg-danger text-white">
          <h5 class="modal-title" id="cancelModalLabel">Cancel Event</h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div class="alert alert-warning">
            <strong>Warning:</strong> This will mark the event as cancelled. You can reactivate it later if needed.
          </div>
          <div class="mb-3">
            <label for="cancel_reason" class="form-label">Reason for Cancellation (Optional)</label>
            <textarea class="form-control" 
                      id="cancel_reason" 
                      name="reason" 
                      rows="3" 
                      placeholder="e.g., Speaker unavailable, venue issue, insufficient interest..."></textarea>
            <small class="form-text text-muted">This will be visible to users viewing the event</small>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Don't Cancel</button>
          <%= f.submit "Cancel Event", class: "btn btn-danger" %>
        </div>
      <% end %>
    </div>
  </div>
</div>
