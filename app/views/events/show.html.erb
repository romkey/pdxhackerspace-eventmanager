<div class="row">
  <div class="col-lg-8">
    <% if @event.banner_image.attached? %>
      <div class="mb-4 event-banner">
        <%= image_tag @event.banner_image, class: "img-fluid rounded", style: "width: 100%; max-height: 400px; object-fit: cover;", alt: @event.title %>
      </div>
    <% end %>
    
    <div class="d-flex justify-content-between align-items-start mb-3">
      <h1><%= @event.title %></h1>
      <% if @event.status != 'active' %>
        <span class="badge bg-<%= @event.status == 'postponed' ? 'warning' : 'danger' %> fs-5">
          <%= @event.status.titleize %>
        </span>
      <% end %>
    </div>

    <% if @event.status == 'postponed' && @event.postponed_until %>
      <div class="alert alert-warning">
        <h5 class="alert-heading">
          <i class="bi bi-clock-history"></i> Event Postponed
        </h5>
        <p class="mb-0"><strong>Rescheduled to:</strong> <%= @event.postponed_until.strftime('%B %d, %Y at %I:%M %p') %></p>
        <% if @event.cancellation_reason.present? %>
          <hr>
          <p class="mb-0"><strong>Reason:</strong> <%= @event.cancellation_reason %></p>
        <% end %>
      </div>
    <% elsif @event.status == 'cancelled' %>
      <div class="alert alert-danger">
        <h5 class="alert-heading">
          <i class="bi bi-x-circle"></i> Event Cancelled
        </h5>
        <% if @event.cancellation_reason.present? %>
          <p class="mb-0"><strong>Reason:</strong> <%= @event.cancellation_reason %></p>
        <% else %>
          <p class="mb-0">This event has been cancelled.</p>
        <% end %>
      </div>
    <% end %>

    <div class="card mb-4">
      <div class="card-body">
        <h5 class="card-title">Description</h5>
        <p class="card-text"><%= simple_format(@event.description) %></p>
        
        <% if @event.more_info_url.present? %>
          <div class="mt-3">
            <%= link_to sanitize(@event.more_info_url), target: "_blank", rel: "noopener noreferrer", class: "btn btn-outline-primary" do %>
              <i class="bi bi-box-arrow-up-right"></i> Learn More About This Event
            <% end %>
          </div>
        <% end %>
      </div>
    </div>

    <% if @event.occurrences.upcoming.any? %>
      <div class="card mb-4">
        <div class="card-body">
          <h5 class="card-title">Upcoming Occurrences</h5>
          <div class="list-group list-group-flush">
            <% @event.occurrences.upcoming.limit(10).each do |occurrence| %>
              <div class="list-group-item d-flex justify-content-between align-items-center">
                <div>
                  <%= occurrence.occurs_at.strftime('%A, %B %d, %Y at %I:%M %p') %>
                  <% if occurrence.status != 'active' %>
                    <span class="badge bg-<%= occurrence.status == 'postponed' ? 'warning' : 'danger' %> ms-2">
                      <%= occurrence.status.titleize %>
                    </span>
                  <% end %>
                </div>
                <% if user_signed_in? && @event.hosted_by?(current_user) %>
                  <div class="btn-group btn-group-sm">
                    <%= link_to "View", event_occurrence_path(occurrence), class: "btn btn-outline-primary" %>
                  </div>
                <% end %>
              </div>
            <% end %>
          </div>
        </div>
      </div>
    <% end %>

    <%= render 'journal', event: @event %>
  </div>

  <div class="col-lg-4">
    <div class="card mb-3">
      <div class="card-body">
        <h5 class="card-title">Event Details</h5>
        <dl class="row mb-0">
          <dt class="col-sm-5">Date:</dt>
          <dd class="col-sm-7"><%= @event.start_time.strftime('%B %d, %Y') %></dd>

          <dt class="col-sm-5">Time:</dt>
          <dd class="col-sm-7"><%= @event.start_time.strftime('%I:%M %p') %> to <%= (@event.start_time + @event.duration.minutes).strftime('%I:%M %p') %></dd>

          <% if @event.hosts.any? %>
            <dt class="col-sm-5">Hosts:</dt>
            <dd class="col-sm-7">
              <% @event.hosts.each do |host| %>
                <div class="d-flex justify-content-between align-items-center mb-1">
                  <span>
                    <%= host.name || host.email %>
                  </span>
                  <% if user_signed_in? && (current_user.admin? || @event.hosted_by?(current_user)) %>
                    <% can_remove = @event.hosts.count > 1 %>
                    <%= button_to event_host_path(@event, host),
                        method: :delete,
                        class: "btn btn-sm btn-outline-danger #{can_remove ? '' : 'disabled'}",
                        disabled: !can_remove,
                        form: { style: "display: inline;", data: { turbo_confirm: can_remove ? "Remove #{host.name || host.email} as a host?" : nil } },
                        title: can_remove ? nil : "Cannot remove the only host" do %>
                      <i class="bi bi-x"></i>
                    <% end %>
                  <% end %>
                </div>
              <% end %>
            </dd>
          <% end %>

          <dt class="col-sm-5">Recurrence:</dt>
          <dd class="col-sm-7"><%= @event.recurrence_type.titleize %></dd>

          <% if @event.location.present? %>
            <dt class="col-sm-5"><i class="bi bi-geo-alt-fill"></i> Location:</dt>
            <dd class="col-sm-7">
              <%= @event.location.name %>
              <% if @event.location.description.present? %>
                <br>
                <small class="text-muted"><%= @event.location.description %></small>
              <% end %>
            </dd>
          <% end %>

          <dt class="col-sm-5">Open To:</dt>
          <dd class="col-sm-7">
            <% 
              open_to_label = case @event.open_to
              when 'public' then 'Everyone'
              when 'members' then 'Members Only'
              when 'private' then 'Private'
              else @event.open_to&.titleize
              end
              open_to_icon = @event.open_to == 'public' ? 'door-open' : (@event.open_to == 'members' ? 'people-fill' : 'envelope')
            %>
            <i class="bi bi-<%= open_to_icon %>"></i> <%= open_to_label %>
          </dd>

          <dt class="col-sm-5">Status:</dt>
          <dd class="col-sm-7"><%= @event.status.titleize %></dd>

          <% if @event.requires_mask %>
            <dt class="col-sm-5">Safety:</dt>
            <dd class="col-sm-7">
              <span class="badge bg-info">
                <i class="bi bi-shield-fill-check"></i> Masks Required
              </span>
            </dd>
          <% end %>
        </dl>
      </div>
    </div>

    <div class="card mb-3">
      <div class="card-body">
        <h5 class="card-title">Subscribe</h5>
        <p class="card-text small text-muted">Add this event to your calendar</p>
        <%= link_to event_ical_path(@event.ical_token, format: :ics), class: "btn btn-primary w-100" do %>
          <i class="bi bi-calendar-plus"></i> iCal Feed
        <% end %>
      </div>
    </div>

    <div class="card mb-3">
      <div class="card-body">
        <h5 class="card-title">Embed Calendar</h5>
        <p class="card-text small text-muted">Embed this event's calendar on your website</p>
        <div class="mb-2">
          <%= link_to "Preview Embed", embed_event_path(@event), class: "btn btn-sm btn-outline-primary w-100", target: "_blank" %>
        </div>
        <div class="mt-3">
          <label class="form-label small fw-bold">Embed Code:</label>
          <textarea class="form-control font-monospace small" rows="3" readonly onclick="this.select()"><iframe src="<%= embed_event_url(@event) %>" width="100%" height="600" frameborder="0" style="border: 1px solid #dee2e6; border-radius: 0.25rem;"></iframe></textarea>
          <small class="form-text text-muted">Copy and paste this code into your website</small>
        </div>
      </div>
    </div>

    <% if user_signed_in? && (current_user.admin? || @event.hosted_by?(current_user)) %>
      <div class="card mb-3">
        <div class="card-body">
          <h5 class="card-title">Invite Co-Host</h5>
          <%= form_with url: event_event_hosts_path(@event), method: :post, local: true do |f| %>
            <div class="mb-3">
              <label for="user_id" class="form-label">Select User</label>
              <%= select_tag :user_id, 
                  options_from_collection_for_select(
                    User.where.not(id: @event.hosts.pluck(:id)).order(:name, :email), 
                    :id, 
                    ->(u) { u.name || u.email }
                  ),
                  class: "form-select",
                  prompt: "Choose a user to add as host..." %>
            </div>
            <%= f.submit "Add as Co-Host", class: "btn btn-primary w-100" %>
          <% end %>
        </div>
      </div>

      <div class="card">
        <div class="card-body">
          <h5 class="card-title">Manage Event</h5>
          <div class="d-grid gap-2">
            <%= link_to "Edit", edit_event_path(@event), class: "btn btn-warning" %>
            
            <% if @event.status == 'active' %>
              <% if @event.occurrences.count == 1 %>
                <button type="button" class="btn btn-outline-warning" data-bs-toggle="modal" data-bs-target="#postponeModal">
                  Postpone Occurrence
                </button>
              <% end %>
              <button type="button" class="btn btn-outline-danger" data-bs-toggle="modal" data-bs-target="#cancelModal">
                Cancel Event
              </button>
            <% else %>
              <%= button_to "Reactivate", reactivate_event_path(@event), 
                  method: :post, 
                  class: "btn btn-success" %>
            <% end %>
            
            <%= button_to "Delete", event_path(@event), 
                method: :delete, 
                class: "btn btn-danger",
                form: { data: { turbo_confirm: "Are you sure you want to delete this event? This cannot be undone." } } %>
          </div>
        </div>
      </div>
    <% end %>
  </div>
</div>

<div class="mt-3">
  <%= link_to "â† Back to Events", events_path, class: "btn btn-secondary" %>
</div>

<!-- Postpone Modal (for single-occurrence events) -->
<% if @event.occurrences.count == 1 %>
  <% single_occurrence = @event.occurrences.first %>
  <div class="modal fade" id="postponeModal" tabindex="-1" aria-labelledby="postponeModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <%= form_with url: postpone_event_occurrence_path(single_occurrence), method: :post do |f| %>
          <div class="modal-header">
            <h5 class="modal-title" id="postponeModalLabel">Postpone Occurrence</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <div class="alert alert-info">
              <small>This will mark the current occurrence as postponed and create a new occurrence at the rescheduled date.</small>
            </div>
            <div class="mb-3">
              <label for="postponed_until" class="form-label">Postpone Until</label>
              <input type="datetime-local" 
                     class="form-control" 
                     id="postponed_until" 
                     name="postponed_until"
                     value="<%= 1.week.from_now.strftime('%Y-%m-%dT%H:%M') %>">
              <small class="form-text text-muted">Select when the occurrence should be rescheduled to</small>
            </div>
            <div class="mb-3">
              <label for="postpone_reason" class="form-label">Reason (Optional)</label>
              <textarea class="form-control" 
                        id="postpone_reason" 
                        name="reason" 
                        rows="3" 
                        placeholder="e.g., Equipment maintenance, low registrations, scheduling conflict..."></textarea>
              <small class="form-text text-muted">This will be visible to users viewing the occurrence</small>
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
            <%= f.submit "Postpone Occurrence", class: "btn btn-warning" %>
          </div>
        <% end %>
      </div>
    </div>
  </div>
<% end %>

<!-- Cancel Modal -->
<div class="modal fade" id="cancelModal" tabindex="-1" aria-labelledby="cancelModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <%= form_with url: cancel_event_path(@event), method: :post do |f| %>
        <div class="modal-header bg-danger text-white">
          <h5 class="modal-title" id="cancelModalLabel">Cancel Event</h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div class="alert alert-warning">
            <strong>Warning:</strong> This will mark the event as cancelled. You can reactivate it later if needed.
          </div>
          <div class="mb-3">
            <label for="cancel_reason" class="form-label">Reason for Cancellation (Optional)</label>
            <textarea class="form-control" 
                      id="cancel_reason" 
                      name="reason" 
                      rows="3" 
                      placeholder="e.g., Speaker unavailable, venue issue, insufficient interest..."></textarea>
            <small class="form-text text-muted">This will be visible to users viewing the event</small>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Don't Cancel</button>
          <%= f.submit "Cancel Event", class: "btn btn-danger" %>
        </div>
      <% end %>
    </div>
  </div>
</div>
