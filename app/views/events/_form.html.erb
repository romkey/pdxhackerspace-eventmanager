<%= form_with(model: event, local: true, class: "needs-validation", "aria-label": "Event form") do |f| %>
  <% if event.errors.any? %>
    <div class="alert alert-danger" role="alert" aria-live="assertive">
      <h2 class="h4"><%= pluralize(event.errors.count, "error") %> prohibited this event from being saved:</h2>
      <ul>
        <% event.errors.full_messages.each do |message| %>
          <li><%= message %></li>
        <% end %>
      </ul>
    </div>
  <% end %>

  <div class="card mb-3">
    <div class="card-header">
      <h5 class="mb-0"><i class="bi bi-info-circle"></i> Event Details</h5>
    </div>
    <div class="card-body">
      <div class="mb-3">
        <%= f.label :title, class: "form-label" %>
        <%= f.text_field :title, class: "form-control", required: true, placeholder: "Weekly Meetup" %>
      </div>

      <div class="mb-3">
        <%= f.label :description, class: "form-label" %>
        <div class="alert alert-info py-2 mb-2" role="note">
          <small>
            <i class="bi bi-info-circle" aria-hidden="true"></i>
            <strong>What to include in your description:</strong>
            Who is invited, what the event is about, any signup or RSVP links, what to bring, 
            skill level requirements, costs (if any), and other important details that help 
            people understand if this event is for them.
          </small>
        </div>
        <%= f.text_area :description, class: "form-control", rows: 5, placeholder: "Describe your event...", "aria-describedby": "description-help" %>
      </div>

      <div class="mb-3">
        <%= f.label :more_info_url, "More Info URL (Optional)", class: "form-label" %>
        <%= f.url_field :more_info_url, class: "form-control", placeholder: "https://example.com/event-details", "aria-describedby": "more-info-url-help" %>
        <small class="form-text text-muted" id="more-info-url-help">
          <i class="bi bi-link-45deg" aria-hidden="true"></i> Add a link where attendees can learn more (website, registration page, etc.)
        </small>
      </div>

      <div class="mb-3">
        <%= f.label :banner_image, "Banner Image (Optional)", class: "form-label" %>
        <%= f.file_field :banner_image, class: "form-control", accept: "image/*", "aria-describedby": "banner-image-help" %>
        <small class="form-text text-muted" id="banner-image-help">
          <i class="bi bi-image" aria-hidden="true"></i> Recommended: 1200x400 pixels or similar 3:1 aspect ratio. Maximum file size: 5MB. Formats: JPG, PNG, GIF
        </small>
        <% if event.banner_image.attached? %>
          <div class="mt-2">
            <%= image_tag event.banner_image, class: "img-thumbnail", style: "max-width: 300px;", alt: "Current banner image for #{event.title}" %>
            <div class="form-check mt-2">
              <%= f.check_box :remove_banner_image, class: "form-check-input" %>
              <%= f.label :remove_banner_image, "Remove current banner image", class: "form-check-label" %>
            </div>
          </div>
        <% end %>
      </div>

      <div class="mb-0">
        <div class="form-check">
          <%= f.check_box :requires_mask, class: "form-check-input" %>
          <%= f.label :requires_mask, "Masks Required", class: "form-check-label" %>
          <div class="form-text">
            <i class="bi bi-shield-fill-check"></i> Check this if masks are required for safety at this event
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="card mb-3">
    <div class="card-header">
      <h5 class="mb-0"><i class="bi bi-calendar-event"></i> Scheduling</h5>
    </div>
    <div class="card-body">
      <div class="row">
        <div class="col-md-6 mb-3">
          <%= f.label :start_time, "Start Date & Time", class: "form-label" %>
          <%= f.datetime_local_field :start_time, class: "form-control", required: true %>
        </div>

        <div class="col-md-6 mb-3">
          <%= f.label :duration, "Duration (minutes)", class: "form-label" %>
          <%= f.number_field :duration, class: "form-control", value: event.duration || 60, min: 15, step: 15 %>
        </div>
      </div>

      <div class="row">
        <div class="col-md-8 mb-3">
          <%= f.label :recurrence_type, "Recurrence Pattern", class: "form-label" %>
          <%= f.select :recurrence_type, 
              [['One Time Event', 'once'], 
               ['Weekly', 'weekly'], 
               ['Monthly', 'monthly'],
               ['Custom', 'custom']], 
              {}, 
              class: "form-select", 
              id: "recurrence_type_select" %>
        </div>

        <div class="col-md-4 mb-3" id="max_occurrences_field">
          <%= f.label :max_occurrences, "Show Next", class: "form-label" %>
          <%= f.number_field :max_occurrences, class: "form-control", value: event.max_occurrences || 5, min: 1, max: 20 %>
          <small class="form-text text-muted">Number of occurrences to display</small>
        </div>
      </div>

      <% weekly_schedule = parse_weekly_recurrence(event) %>
      <div id="weekly_options" class="mb-3" style="display: none;">
        <div class="alert alert-info py-2 mb-3">
          <small>
            <i class="bi bi-info-circle"></i>
            <strong>Examples:</strong> Select "Every 2 weeks" for biweekly events.
            Check multiple days for events that happen on different days each week.
          </small>
        </div>
        <div class="row">
          <div class="col-md-4 mb-3">
            <label class="form-label">Repeat every:</label>
            <%= select_tag :recurrence_interval,
                options_for_select([
                  ['Every week', 1],
                  ['Every 2 weeks', 2],
                  ['Every 3 weeks', 3],
                  ['Every 4 weeks', 4]
                ], weekly_schedule[:interval]),
                class: "form-select" %>
          </div>
          <div class="col-md-8 mb-3">
            <label class="form-label">On which day(s): <small class="text-muted">(check one or more)</small></label>
            <div class="d-flex flex-wrap gap-3">
              <% [['Sun', 0], ['Mon', 1], ['Tue', 2], ['Wed', 3], ['Thu', 4], ['Fri', 5], ['Sat', 6]].each do |label, value| %>
                <div class="form-check">
                  <%= check_box_tag "recurrence_days[]", value, weekly_schedule[:days].include?(value), id: "weekly_day_#{value}", class: "form-check-input weekly-day-checkbox" %>
                  <%= label_tag "weekly_day_#{value}", label, class: "form-check-label" %>
                </div>
              <% end %>
            </div>
            <small class="form-text text-muted mt-1">
              <i class="bi bi-calendar-week"></i> If no days selected, uses the day from start date
            </small>
          </div>
        </div>
      </div>

      <% monthly_schedule = parse_monthly_recurrence(event) %>
      <div id="monthly_options" class="mb-3" style="display: none;">
        <div class="alert alert-info py-2 mb-3">
          <small>
            <i class="bi bi-info-circle"></i>
            <strong>Examples:</strong> Check "First" and "Third" with "Monday" for events on the 1st and 3rd Monday.
            Use "Except" to exclude specific occurrences (e.g., "Every Saturday except the Last Saturday").
          </small>
        </div>
        <div class="row">
          <div class="col-md-4 mb-3">
            <label class="form-label">Which week(s): <small class="text-muted">(include)</small></label>
            <div class="d-flex flex-column gap-2">
              <% [['First', 'first'], ['Second', 'second'], ['Third', 'third'], ['Fourth', 'fourth'], ['Last', 'last']].each do |label, value| %>
                <div class="form-check">
                  <%= check_box_tag "recurrence_occurrences[]", value, monthly_schedule[:occurrences].include?(value), id: "occurrence_#{value}", class: "form-check-input" %>
                  <%= label_tag "occurrence_#{value}", label, class: "form-check-label" %>
                </div>
              <% end %>
            </div>
          </div>
          <div class="col-md-4 mb-3">
            <label class="form-label">Except: <small class="text-muted">(exclude)</small></label>
            <div class="d-flex flex-column gap-2">
              <% [['First', 'first'], ['Second', 'second'], ['Third', 'third'], ['Fourth', 'fourth'], ['Last', 'last']].each do |label, value| %>
                <div class="form-check">
                  <%= check_box_tag "recurrence_except_occurrences[]", value, monthly_schedule[:except_occurrences]&.include?(value), id: "except_occurrence_#{value}", class: "form-check-input" %>
                  <%= label_tag "except_occurrence_#{value}", label, class: "form-check-label text-muted" %>
                </div>
              <% end %>
            </div>
          </div>
          <div class="col-md-4 mb-3">
            <label class="form-label">On which day:</label>
            <%= select_tag :recurrence_day,
                options_for_select([
                  ['Monday', 'monday'],
                  ['Tuesday', 'tuesday'],
                  ['Wednesday', 'wednesday'],
                  ['Thursday', 'thursday'],
                  ['Friday', 'friday'],
                  ['Saturday', 'saturday'],
                  ['Sunday', 'sunday']
                ], monthly_schedule[:day]),
                class: "form-select" %>
          </div>
        </div>
      </div>

      <div id="custom_options" class="mb-3" style="display: none;">
        <div class="alert alert-warning py-2 mb-3">
          <small>
            <i class="bi bi-exclamation-triangle"></i>
            <strong>Advanced:</strong> Custom schedules let you combine multiple rules.
            For alternating patterns (e.g., Tuesday one week, Thursday the next), add two rules 
            with "Every 2 weeks" and set different "Start on" weeks for each.
          </small>
        </div>
        <div id="custom_rules_container">
          <!-- Custom rules will be added dynamically -->
        </div>
        <button type="button" class="btn btn-outline-secondary btn-sm" id="add_custom_rule">
          <i class="bi bi-plus-circle"></i> Add Rule
        </button>
      </div>

      <div class="mb-0">
        <%= f.label :location_id, "Location", class: "form-label" %>
        <%= f.collection_select :location_id, Location.alphabetical, :id, :name,
            { prompt: "No specific location", include_blank: true },
            class: "form-select" %>
        <small class="form-text text-muted">
          <i class="bi bi-geo-alt"></i> Where this event typically happens
        </small>
      </div>
    </div>
  </div>

  <div class="card mb-3">
    <div class="card-header">
      <h5 class="mb-0"><i class="bi bi-eye"></i> Visibility & Publishing</h5>
    </div>
    <div class="card-body">
      <div class="row">
        <div class="col-md-6 mb-3">
          <%= f.label :visibility, "Event Visibility", class: "form-label" %>
          <%= f.select :visibility, 
              [
                ['Public - Anyone can view', 'public'],
                ['Members Only - Signed in users can view', 'members'],
                ['Private - Only you and admins can view', 'private']
              ], 
              {}, 
              class: "form-select" %>
          <small class="form-text text-muted">
            Who can see this event
          </small>
        </div>

        <div class="col-md-6 mb-3">
          <%= f.label :open_to, "Open To", class: "form-label" %>
          <%= f.select :open_to, 
              [
                ['Public - Open to everyone', 'public'],
                ['Members Only - Members can attend', 'members'],
                ['Private - Invitation only', 'private']
              ], 
              {}, 
              class: "form-select" %>
          <small class="form-text text-muted">
            Who can attend this event
          </small>
        </div>
      </div>

      <div class="mb-3">
        <div class="form-check">
          <%= f.check_box :draft, class: "form-check-input" %>
          <%= f.label :draft, "Save as Draft", class: "form-check-label" %>
          <div class="form-text">
            <i class="bi bi-file-earmark-text"></i> Draft events are only visible to you and won't appear in any public feeds or listings
          </div>
        </div>
      </div>

      <div class="mb-3">
        <div class="form-check">
          <%= f.check_box :sign_feed, class: "form-check-input" %>
          <%= f.label :sign_feed, "Show on E-Ink Signs", class: "form-check-label" %>
          <div class="form-text">
            <i class="bi bi-display"></i> Include this event in the feed for e-ink display signs
          </div>
        </div>
      </div>

      <div class="mb-3">
        <div class="form-check">
          <%= f.check_box :default_to_cancelled, class: "form-check-input" %>
          <%= f.label :default_to_cancelled, "Default to Cancelled", class: "form-check-label text-warning" %>
          <div class="form-text text-warning">
            <i class="bi bi-calendar-x"></i> New occurrences are created as cancelled by default. Manually activate the dates that will happen. Useful for "every week except one" patterns.
          </div>
        </div>
      </div>

      <div class="mb-3">
        <div class="form-check">
          <%= f.check_box :permanently_cancelled, class: "form-check-input" %>
          <%= f.label :permanently_cancelled, "Permanently Cancelled", class: "form-check-label text-danger" %>
          <div class="form-text text-danger">
            <i class="bi bi-x-circle-fill"></i> All future occurrences will be created as cancelled and no new ones will be generated. Use this for events that are no longer running.
          </div>
        </div>
      </div>

      <div class="mb-3">
        <div class="form-check">
          <%= f.check_box :permanently_relocated, class: "form-check-input", id: "permanently_relocated_checkbox" %>
          <%= f.label :permanently_relocated, "Permanently Relocated", class: "form-check-label text-info" %>
          <div class="form-text text-info">
            <i class="bi bi-geo-alt-fill"></i> This event has moved to a new location permanently. All occurrences will be marked as relocated and no new ones will be generated.
          </div>
        </div>
        <div id="relocated_to_field" class="mt-2 ms-4" style="display: <%= event.permanently_relocated? ? 'block' : 'none' %>;">
          <%= f.label :relocated_to, "New Location", class: "form-label" %>
          <%= f.text_field :relocated_to, class: "form-control", placeholder: "e.g., New venue name, address, or URL" %>
          <small class="form-text text-muted">Where has this event moved to?</small>
        </div>
      </div>
    </div>
  </div>

  <% site_config = SiteConfig.current %>
  <% if site_config.slack_enabled? || site_config.social_reminders_enabled? %>
    <% ollama_configured = ENV['OLLAMA_SERVER'].present? %>
    <% short_max = site_config.short_reminder_max_length %>
    <% long_max = site_config.long_reminder_max_length %>
    <div class="card mb-3" id="reminder-messages-section"
         data-generate-ai-url="<%= event.persisted? ? generate_ai_reminder_event_path(event) : '' %>"
         data-ai-event-description="<%= h(event.description.to_s) %>">
      <div class="card-header">
        <h5 class="mb-0"><i class="bi bi-chat-left-text"></i> Notifications & Reminders</h5>
        <small class="text-muted">These messages will be used for all occurrences unless overridden. Short = Bluesky, Long = Slack/Instagram.</small>
      </div>
      <div class="card-body">
        <div class="row mb-3">
          <div class="col-md-6">
            <div class="form-check">
              <%= f.check_box :slack_announce, class: "form-check-input" %>
              <%= f.label :slack_announce, "Post to Slack", class: "form-check-label" %>
              <div class="form-text">
                <i class="bi bi-slack"></i> Reminders posted 6 days and 1 day before (public/members-only events)
              </div>
            </div>
          </div>
          <div class="col-md-6">
            <div class="form-check">
              <%= f.check_box :social_reminders, class: "form-check-input" %>
              <%= f.label :social_reminders, "Post to Social Media", class: "form-check-label" %>
              <div class="form-text">
                <i class="bi bi-share"></i> Reminders posted to Instagram and Bluesky (public/members-only events)
              </div>
            </div>
          </div>
        </div>

        <hr class="my-3">

        <div class="alert alert-info py-2 mb-3" role="note">
          <small>
            <i class="bi bi-info-circle" aria-hidden="true"></i>
            <strong>Tip:</strong> Use <code>{{when}}</code> as a placeholder for the date and time. 
            It will be automatically replaced with the actual date/time for each occurrence.
            <br>
            <em>Example: "Join us for <%= event.title %> {{when}} at PDX Hackerspace!"</em>
          </small>
        </div>
        <h6 class="text-muted mb-3">6-Day Reminders</h6>
        <div class="row">
          <div class="col-md-6 mb-3">
            <%= f.label :reminder_7d_short, "Short (#{short_max} chars max)", class: "form-label" %>
            <%= f.text_area :reminder_7d_short, 
                class: "form-control", 
                rows: 4, 
                maxlength: short_max,
                id: "event_reminder_7d_short",
                placeholder: event.reminder_short_default(7),
                data: { default_text: event.reminder_short_default(7) } %>
            <div class="d-flex justify-content-between align-items-center mt-1">
              <small class="text-muted char-count" data-target="event_reminder_7d_short">0/<%=short_max%></small>
              <div class="btn-group btn-group-sm">
                <button type="button" class="btn btn-outline-secondary btn-sm" data-action="set-default" data-target="event_reminder_7d_short">Default</button>
                <% if ollama_configured %>
                  <button type="button" class="btn btn-outline-primary btn-sm" data-action="regenerate" data-target="event_reminder_7d_short" data-type="short"><i class="bi bi-stars"></i> AI</button>
                <% end %>
              </div>
            </div>
          </div>
          <div class="col-md-6 mb-3">
            <%= f.label :reminder_7d_long, "Long (#{long_max} chars max)", class: "form-label" %>
            <%= f.text_area :reminder_7d_long, 
                class: "form-control", 
                rows: 6, 
                maxlength: long_max,
                id: "event_reminder_7d_long",
                placeholder: event.reminder_long_default(7),
                data: { default_text: event.reminder_long_default(7) } %>
            <div class="d-flex justify-content-between align-items-center mt-1">
              <small class="text-muted char-count" data-target="event_reminder_7d_long">0/<%=long_max%></small>
              <div class="btn-group btn-group-sm">
                <button type="button" class="btn btn-outline-secondary btn-sm" data-action="set-default" data-target="event_reminder_7d_long">Default</button>
                <% if ollama_configured %>
                  <button type="button" class="btn btn-outline-primary btn-sm" data-action="regenerate" data-target="event_reminder_7d_long" data-type="long"><i class="bi bi-stars"></i> AI</button>
                <% end %>
              </div>
            </div>
          </div>
        </div>

        <h6 class="text-muted mb-3">1-Day Reminders</h6>
        <div class="row">
          <div class="col-md-6 mb-3">
            <%= f.label :reminder_1d_short, "Short (#{short_max} chars max)", class: "form-label" %>
            <%= f.text_area :reminder_1d_short, 
                class: "form-control", 
                rows: 4, 
                maxlength: short_max,
                id: "event_reminder_1d_short",
                placeholder: event.reminder_short_default(1),
                data: { default_text: event.reminder_short_default(1) } %>
            <div class="d-flex justify-content-between align-items-center mt-1">
              <small class="text-muted char-count" data-target="event_reminder_1d_short">0/<%=short_max%></small>
              <div class="btn-group btn-group-sm">
                <button type="button" class="btn btn-outline-secondary btn-sm" data-action="set-default" data-target="event_reminder_1d_short">Default</button>
                <% if ollama_configured %>
                  <button type="button" class="btn btn-outline-primary btn-sm" data-action="regenerate" data-target="event_reminder_1d_short" data-type="short"><i class="bi bi-stars"></i> AI</button>
                <% end %>
              </div>
            </div>
          </div>
          <div class="col-md-6 mb-3">
            <%= f.label :reminder_1d_long, "Long (#{long_max} chars max)", class: "form-label" %>
            <%= f.text_area :reminder_1d_long, 
                class: "form-control", 
                rows: 6, 
                maxlength: long_max,
                id: "event_reminder_1d_long",
                placeholder: event.reminder_long_default(1),
                data: { default_text: event.reminder_long_default(1) } %>
            <div class="d-flex justify-content-between align-items-center mt-1">
              <small class="text-muted char-count" data-target="event_reminder_1d_long">0/<%=long_max%></small>
              <div class="btn-group btn-group-sm">
                <button type="button" class="btn btn-outline-secondary btn-sm" data-action="set-default" data-target="event_reminder_1d_long">Default</button>
                <% if ollama_configured %>
                  <button type="button" class="btn btn-outline-primary btn-sm" data-action="regenerate" data-target="event_reminder_1d_long" data-type="long"><i class="bi bi-stars"></i> AI</button>
                <% end %>
              </div>
            </div>
          </div>
        </div>

        <% unless ollama_configured %>
          <div class="alert alert-info py-2 mb-0">
            <small><i class="bi bi-info-circle"></i> AI generation is disabled. Configure OLLAMA_SERVER to enable.</small>
          </div>
        <% end %>
      </div>
    </div>
  <% end %>

  <div class="mt-4">
    <%= f.submit class: "btn btn-primary" %>
    <%= link_to "Cancel", events_path, class: "btn btn-secondary" %>
  </div>
<% end %>

<script>
  function initRecurrenceOptions() {
    const recurrenceSelect = document.getElementById('recurrence_type_select');
    const weeklyOptions = document.getElementById('weekly_options');
    const monthlyOptions = document.getElementById('monthly_options');
    const customOptions = document.getElementById('custom_options');
    const startTimeField = document.querySelector('input[name="event[start_time]"]');

    if (!recurrenceSelect) return; // Guard in case form not present

    const dayNames = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];

    // Auto-select the day from start time if no days are checked
    function autoSelectWeeklyDay() {
      if (!startTimeField || !startTimeField.value) return;
      
      const date = new Date(startTimeField.value);
      const dayNum = date.getDay();
      const checkboxes = document.querySelectorAll('.weekly-day-checkbox');
      const anyChecked = Array.from(checkboxes).some(cb => cb.checked);
      
      if (!anyChecked) {
        const checkbox = document.getElementById(`weekly_day_${dayNum}`);
        if (checkbox) checkbox.checked = true;
      }
    }

    function updateRecurrenceOptions() {
      const value = recurrenceSelect.value;
      
      weeklyOptions.style.display = value === 'weekly' ? 'block' : 'none';
      monthlyOptions.style.display = value === 'monthly' ? 'block' : 'none';
      if (customOptions) customOptions.style.display = value === 'custom' ? 'block' : 'none';
      
      if (value === 'weekly') {
        autoSelectWeeklyDay();
      }
    }

    recurrenceSelect.addEventListener('change', updateRecurrenceOptions);
    if (startTimeField) {
      startTimeField.addEventListener('change', autoSelectWeeklyDay);
    }
    updateRecurrenceOptions(); // Run immediately to show correct state

    // Custom rules functionality
    initCustomRules();
  }

  let customRuleCount = 0;

  function initCustomRules() {
    const addButton = document.getElementById('add_custom_rule');
    if (!addButton) return;

    addButton.addEventListener('click', addCustomRule);
  }

  function addCustomRule() {
    const container = document.getElementById('custom_rules_container');
    if (!container) return;

    const ruleIndex = customRuleCount++;
    const ruleHtml = `
      <div class="card mb-2 custom-rule" data-rule-index="${ruleIndex}">
        <div class="card-body py-2">
          <div class="d-flex justify-content-between align-items-start mb-2">
            <strong>Rule ${ruleIndex + 1}</strong>
            <button type="button" class="btn btn-sm btn-outline-danger" onclick="removeCustomRule(${ruleIndex})">
              <i class="bi bi-trash"></i>
            </button>
          </div>
          <div class="row">
            <div class="col-md-3 mb-2">
              <label class="form-label small">Type:</label>
              <select name="custom_rules[${ruleIndex}][type]" class="form-select form-select-sm custom-rule-type" data-rule="${ruleIndex}">
                <option value="weekly">Weekly</option>
                <option value="monthly">Monthly</option>
              </select>
            </div>
            <div class="col-md-9">
              <div class="custom-rule-weekly-options" data-rule="${ruleIndex}">
                <div class="row">
                  <div class="col-md-3 mb-2">
                    <label class="form-label small">Interval:</label>
                    <select name="custom_rules[${ruleIndex}][interval]" class="form-select form-select-sm custom-rule-interval" data-rule="${ruleIndex}">
                      <option value="1">Every week</option>
                      <option value="2">Every 2 weeks</option>
                      <option value="3">Every 3 weeks</option>
                      <option value="4">Every 4 weeks</option>
                    </select>
                  </div>
                  <div class="col-md-3 mb-2 week-offset-container" data-rule="${ruleIndex}" style="display: none;">
                    <label class="form-label small">Start on:</label>
                    <select name="custom_rules[${ruleIndex}][week_offset]" class="form-select form-select-sm">
                      <option value="0">This week</option>
                      <option value="1">Next week</option>
                      <option value="2">Week 3</option>
                      <option value="3">Week 4</option>
                    </select>
                  </div>
                  <div class="col-md-6 mb-2">
                    <label class="form-label small">Days:</label>
                    <div class="d-flex flex-wrap gap-2">
                      ${['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'].map((day, i) => `
                        <div class="form-check form-check-inline">
                          <input type="checkbox" name="custom_rules[${ruleIndex}][days][]" value="${i}" 
                                 id="custom_rule_${ruleIndex}_day_${i}" class="form-check-input">
                          <label for="custom_rule_${ruleIndex}_day_${i}" class="form-check-label small">${day}</label>
                        </div>
                      `).join('')}
                    </div>
                  </div>
                </div>
              </div>
              <div class="custom-rule-monthly-options" data-rule="${ruleIndex}" style="display: none;">
                <div class="row">
                  <div class="col-md-6 mb-2">
                    <label class="form-label small">Week(s):</label>
                    <div class="d-flex flex-wrap gap-2">
                      ${['first', 'second', 'third', 'fourth', 'last'].map(occ => `
                        <div class="form-check form-check-inline">
                          <input type="checkbox" name="custom_rules[${ruleIndex}][occurrences][]" value="${occ}" 
                                 id="custom_rule_${ruleIndex}_occ_${occ}" class="form-check-input">
                          <label for="custom_rule_${ruleIndex}_occ_${occ}" class="form-check-label small">${occ.charAt(0).toUpperCase() + occ.slice(1)}</label>
                        </div>
                      `).join('')}
                    </div>
                  </div>
                  <div class="col-md-6 mb-2">
                    <label class="form-label small">Day:</label>
                    <select name="custom_rules[${ruleIndex}][day]" class="form-select form-select-sm">
                      ${['monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday', 'sunday'].map(day => `
                        <option value="${day}">${day.charAt(0).toUpperCase() + day.slice(1)}</option>
                      `).join('')}
                    </select>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    `;

    container.insertAdjacentHTML('beforeend', ruleHtml);

    // Add event listener for rule type change
    const typeSelect = container.querySelector(`select.custom-rule-type[data-rule="${ruleIndex}"]`);
    if (typeSelect) {
      typeSelect.addEventListener('change', function() {
        updateCustomRuleOptions(ruleIndex, this.value);
      });
    }

    // Add event listener for interval change to show/hide week offset
    const intervalSelect = container.querySelector(`select.custom-rule-interval[data-rule="${ruleIndex}"]`);
    if (intervalSelect) {
      intervalSelect.addEventListener('change', function() {
        updateWeekOffsetVisibility(ruleIndex, this.value);
      });
    }
  }

  function updateWeekOffsetVisibility(ruleIndex, interval) {
    const offsetContainer = document.querySelector(`.week-offset-container[data-rule="${ruleIndex}"]`);
    if (offsetContainer) {
      // Show week offset only for intervals > 1 (alternating patterns)
      offsetContainer.style.display = parseInt(interval) > 1 ? 'block' : 'none';
    }
  }

  function updateCustomRuleOptions(ruleIndex, type) {
    const weeklyOptions = document.querySelector(`.custom-rule-weekly-options[data-rule="${ruleIndex}"]`);
    const monthlyOptions = document.querySelector(`.custom-rule-monthly-options[data-rule="${ruleIndex}"]`);
    
    if (weeklyOptions) weeklyOptions.style.display = type === 'weekly' ? 'block' : 'none';
    if (monthlyOptions) monthlyOptions.style.display = type === 'monthly' ? 'block' : 'none';
  }

  function removeCustomRule(ruleIndex) {
    const rule = document.querySelector(`.custom-rule[data-rule-index="${ruleIndex}"]`);
    if (rule) rule.remove();
  }

  // Support both Turbo and regular page loads
  document.addEventListener('DOMContentLoaded', initRecurrenceOptions);
  document.addEventListener('turbo:load', initRecurrenceOptions);
  document.addEventListener('turbo:render', initRecurrenceOptions);

  // Reminder message buttons
  function initReminderButtons() {
    const reminderSection = document.getElementById('reminder-messages-section');
    if (!reminderSection) return;

    reminderSection.addEventListener("click", function(event) {
      const button = event.target.closest("[data-action]");
      if (!button) return;
      
      // Prevent any form submission
      event.preventDefault();
      event.stopPropagation();
      
      const targetId = button.dataset.target;
      if (!targetId) return;
      
      const textarea = document.getElementById(targetId);
      if (!textarea) return;

      if (button.dataset.action === "set-default") {
        textarea.value = textarea.dataset.defaultText || "";
        updateCharCount(textarea);
      }

      if (button.dataset.action === "regenerate") {
        generateAiMessageForEvent(button, targetId);
      }
    });
  }

  async function generateAiMessageForEvent(button, targetId) {
    const textarea = document.getElementById(targetId);
    if (!textarea) {
      console.error('Textarea not found:', targetId);
      return;
    }

    const reminderSection = document.getElementById('reminder-messages-section');
    const url = reminderSection?.dataset.generateAiUrl;
    
    if (!url) {
      alert('AI generation is not available. Save the event first to enable AI generation.');
      return;
    }

    const days = targetId.includes('_7d') ? 7 : 1;
    const messageType = button.dataset.type || 'short';
    const originalHTML = button.innerHTML;
    
    // Store reference to reset button state
    const resetButton = () => {
      button.disabled = false;
      button.innerHTML = originalHTML;
    };

    button.disabled = true;
    button.innerHTML = '<span class="spinner-border spinner-border-sm" role="status"></span>';

    try {
      const csrfToken = document.querySelector('meta[name="csrf-token"]')?.content;
      console.log('Generating AI reminder:', { url, days, messageType });
      
      const response = await fetch(url, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Accept': 'application/json',
          'X-CSRF-Token': csrfToken
        },
        body: JSON.stringify({ days: days, type: messageType })
      });

      console.log('AI response status:', response.status);
      
      if (!response.ok) {
        const errorText = await response.text();
        console.error('AI generation error response:', errorText);
        alert(`AI generation failed (${response.status}). Check console for details.`);
        resetButton();
        return;
      }

      const data = await response.json();
      console.log('AI response data:', data);
      
      if (data.success) {
        textarea.value = data.message;
        textarea.classList.add("is-valid");
        updateCharCount(textarea);
        setTimeout(() => textarea.classList.remove("is-valid"), 2000);
      } else {
        alert(`AI generation failed: ${data.message}`);
      }
    } catch (error) {
      console.error('Error generating AI reminder:', error);
      alert('An error occurred during AI generation. Please try again.');
    }
    
    // Always reset button state
    resetButton();
  }

  // Character count for textareas
  function updateCharCount(textarea) {
    const countEl = document.querySelector(`.char-count[data-target="${textarea.id}"]`);
    if (countEl) {
      const max = textarea.maxLength;
      const current = textarea.value.length;
      countEl.textContent = `${current}/${max}`;
      countEl.classList.toggle('text-danger', current > max * 0.9);
    }
  }

  function initCharCounts() {
    document.querySelectorAll('textarea[maxlength]').forEach(textarea => {
      updateCharCount(textarea);
      textarea.addEventListener('input', () => updateCharCount(textarea));
    });
  }

  document.addEventListener('DOMContentLoaded', initReminderButtons);
  document.addEventListener('turbo:load', initReminderButtons);
  document.addEventListener('DOMContentLoaded', initCharCounts);
  document.addEventListener('turbo:load', initCharCounts);

  // Toggle relocated_to field visibility
  function initRelocatedField() {
    const checkbox = document.getElementById('permanently_relocated_checkbox');
    const field = document.getElementById('relocated_to_field');
    if (!checkbox || !field) return;

    checkbox.addEventListener('change', function() {
      field.style.display = this.checked ? 'block' : 'none';
      if (!this.checked) {
        const input = field.querySelector('input');
        if (input) input.value = '';
      }
    });
  }

  document.addEventListener('DOMContentLoaded', initRelocatedField);
  document.addEventListener('turbo:load', initRelocatedField);
</script>

