<%= form_with(model: event, local: true, class: "needs-validation", "aria-label": "Event form") do |f| %>
  <% if event.errors.any? %>
    <div class="alert alert-danger" role="alert" aria-live="assertive">
      <h2 class="h4"><%= pluralize(event.errors.count, "error") %> prohibited this event from being saved:</h2>
      <ul>
        <% event.errors.full_messages.each do |message| %>
          <li><%= message %></li>
        <% end %>
      </ul>
    </div>
  <% end %>

  <div class="mb-3">
    <%= f.label :title, class: "form-label" %>
    <%= f.text_field :title, class: "form-control", required: true, placeholder: "Weekly Meetup" %>
  </div>

  <div class="mb-3">
    <%= f.label :description, class: "form-label" %>
    <div class="alert alert-info py-2 mb-2" role="note">
      <small>
        <i class="bi bi-info-circle" aria-hidden="true"></i>
        <strong>What to include in your description:</strong>
        Who is invited, what the event is about, any signup or RSVP links, what to bring, 
        skill level requirements, costs (if any), and other important details that help 
        people understand if this event is for them.
      </small>
    </div>
    <%= f.text_area :description, class: "form-control", rows: 5, placeholder: "Describe your event...", "aria-describedby": "description-help" %>
  </div>

  <div class="mb-3">
    <%= f.label :more_info_url, "More Info URL (Optional)", class: "form-label" %>
    <%= f.url_field :more_info_url, class: "form-control", placeholder: "https://example.com/event-details", "aria-describedby": "more-info-url-help" %>
    <small class="form-text text-muted" id="more-info-url-help">
      <i class="bi bi-link-45deg" aria-hidden="true"></i> Add a link where attendees can learn more (website, registration page, etc.)
    </small>
  </div>

  <div class="mb-3">
    <%= f.label :banner_image, "Banner Image (Optional)", class: "form-label" %>
    <%= f.file_field :banner_image, class: "form-control", accept: "image/*", "aria-describedby": "banner-image-help" %>
    <small class="form-text text-muted" id="banner-image-help">
      <i class="bi bi-image" aria-hidden="true"></i> Recommended: 1200x400 pixels or similar 3:1 aspect ratio. Maximum file size: 5MB. Formats: JPG, PNG, GIF
    </small>
    <% if event.banner_image.attached? %>
      <div class="mt-2">
        <%= image_tag event.banner_image, class: "img-thumbnail", style: "max-width: 300px;", alt: "Current banner image for #{event.title}" %>
        <div class="form-check mt-2">
          <%= f.check_box :remove_banner_image, class: "form-check-input" %>
          <%= f.label :remove_banner_image, "Remove current banner image", class: "form-check-label" %>
        </div>
      </div>
    <% end %>
  </div>

  <div class="card mb-3">
    <div class="card-header">
      <h5 class="mb-0"><i class="bi bi-calendar-event"></i> Scheduling</h5>
    </div>
    <div class="card-body">
      <div class="row">
        <div class="col-md-6 mb-3">
          <%= f.label :start_time, "Start Date & Time", class: "form-label" %>
          <%= f.datetime_local_field :start_time, class: "form-control", required: true %>
        </div>

        <div class="col-md-6 mb-3">
          <%= f.label :duration, "Duration (minutes)", class: "form-label" %>
          <%= f.number_field :duration, class: "form-control", value: event.duration || 60, min: 15, step: 15 %>
        </div>
      </div>

      <div class="row">
        <div class="col-md-8 mb-3">
          <%= f.label :recurrence_type, "Recurrence Pattern", class: "form-label" %>
          <%= f.select :recurrence_type, 
              [['One Time Event', 'once'], 
               ['Weekly', 'weekly'], 
               ['Monthly', 'monthly'],
               ['Custom', 'custom']], 
              {}, 
              class: "form-select", 
              id: "recurrence_type_select" %>
        </div>

        <div class="col-md-4 mb-3" id="max_occurrences_field">
          <%= f.label :max_occurrences, "Show Next", class: "form-label" %>
          <%= f.number_field :max_occurrences, class: "form-control", value: event.max_occurrences || 5, min: 1, max: 20 %>
          <small class="form-text text-muted">Number of occurrences to display</small>
        </div>
      </div>

      <div id="weekly_options" class="mb-3" style="display: none;">
        <label class="form-label">Repeat on days:</label>
        <div class="d-flex flex-wrap gap-2">
          <% weekly_days = parse_weekly_recurrence(event) %>
          <% Date::DAYNAMES.each_with_index do |day, index| %>
            <div class="form-check">
              <%= check_box_tag "recurrence_days[]", index, weekly_days.include?(index), id: "day_#{index}", class: "form-check-input" %>
              <%= label_tag "day_#{index}", day, class: "form-check-label" %>
            </div>
          <% end %>
        </div>
      </div>

      <div id="monthly_options" class="mb-3" style="display: none;">
        <div class="alert alert-info py-2 mb-3">
          <small>
            <i class="bi bi-info-circle"></i>
            <strong>Examples:</strong> Check "First" and "Third" with "Monday" for events on the 1st and 3rd Monday.
            Check "Second" with "Sunday" for events on the 2nd Sunday of each month.
          </small>
        </div>
        <div class="row">
          <% monthly_schedule = parse_monthly_recurrence(event) %>
          <div class="col-md-6">
            <label class="form-label">Which week(s) of the month: <small class="text-muted">(check one or more)</small></label>
            <div class="d-flex flex-column gap-2">
              <% [['First', 'first'], ['Second', 'second'], ['Third', 'third'], ['Fourth', 'fourth'], ['Last', 'last']].each do |label, value| %>
                <div class="form-check">
                  <%= check_box_tag "recurrence_occurrences[]", value, monthly_schedule[:occurrences].include?(value), id: "occurrence_#{value}", class: "form-check-input" %>
                  <%= label_tag "occurrence_#{value}", label, class: "form-check-label" %>
                </div>
              <% end %>
            </div>
          </div>
          <div class="col-md-6">
            <label class="form-label">On which day of the week:</label>
            <%= select_tag :recurrence_day,
                options_for_select([
                  ['Monday', 'monday'],
                  ['Tuesday', 'tuesday'],
                  ['Wednesday', 'wednesday'],
                  ['Thursday', 'thursday'],
                  ['Friday', 'friday'],
                  ['Saturday', 'saturday'],
                  ['Sunday', 'sunday']
                ], monthly_schedule[:day]),
                class: "form-select" %>
            <small class="form-text text-muted">
              <i class="bi bi-calendar-week"></i> You can select multiple weeks above for complex schedules
            </small>
          </div>
        </div>
      </div>

      <div class="mb-0">
        <%= f.label :location_id, "Location", class: "form-label" %>
        <%= f.collection_select :location_id, Location.alphabetical, :id, :name,
            { prompt: "No specific location", include_blank: true },
            class: "form-select" %>
        <small class="form-text text-muted">
          <i class="bi bi-geo-alt"></i> Where this event typically happens
        </small>
      </div>
    </div>
  </div>

  <div class="row">
    <div class="col-md-6 mb-3">
      <%= f.label :visibility, "Event Visibility", class: "form-label" %>
      <%= f.select :visibility, 
          [
            ['Public - Anyone can view', 'public'],
            ['Members Only - Signed in users can view', 'members'],
            ['Private - Only you and admins can view', 'private']
          ], 
          {}, 
          class: "form-select" %>
      <small class="form-text text-muted">
        Who can see this event
      </small>
    </div>

    <div class="col-md-6 mb-3">
      <%= f.label :open_to, "Open To", class: "form-label" %>
      <%= f.select :open_to, 
          [
            ['Public - Open to everyone', 'public'],
            ['Members Only - Members can attend', 'members'],
            ['Private - Invitation only', 'private']
          ], 
          {}, 
          class: "form-select" %>
      <small class="form-text text-muted">
        Who can attend this event
      </small>
    </div>
  </div>

  <div class="mb-3">
    <div class="form-check">
      <%= f.check_box :requires_mask, class: "form-check-input" %>
      <%= f.label :requires_mask, "Masks Required", class: "form-check-label" %>
      <div class="form-text">
        <i class="bi bi-shield-fill-check"></i> Check this if masks are required for safety at this event
      </div>
    </div>
  </div>

  <div class="mb-3">
    <div class="form-check">
      <%= f.check_box :draft, class: "form-check-input" %>
      <%= f.label :draft, "Save as Draft", class: "form-check-label" %>
      <div class="form-text">
        <i class="bi bi-file-earmark-text"></i> Draft events are only visible to you and won't appear in any public feeds or listings
      </div>
    </div>
  </div>

  <div class="mb-3">
    <div class="form-check">
      <%= f.check_box :slack_announce, class: "form-check-input" %>
      <%= f.label :slack_announce, "Post to Slack", class: "form-check-label" %>
      <div class="form-text">
        <i class="bi bi-slack"></i> When enabled, a reminder will be posted to Slack at 9 AM on the day of the event (only for public and members-only events)
      </div>
    </div>
  </div>

  <div class="mb-3">
    <div class="form-check">
      <%= f.check_box :social_reminders, class: "form-check-input" %>
      <%= f.label :social_reminders, "Post to Social Media", class: "form-check-label" %>
      <div class="form-text">
        <i class="bi bi-share"></i> When enabled, reminders will be posted to Instagram and Bluesky one week and one day before the event (public/members-only only)
      </div>
    </div>
  </div>

  <% site_config = SiteConfig.current %>
  <% if site_config.slack_enabled? || site_config.social_reminders_enabled? %>
    <% ollama_configured = ENV['OLLAMA_SERVER'].present? %>
    <% short_max = site_config.short_reminder_max_length %>
    <% long_max = site_config.long_reminder_max_length %>
    <div class="card mb-3" id="reminder-messages-section"
         data-generate-ai-url="<%= event.persisted? ? generate_ai_reminder_event_path(event) : '' %>"
         data-ai-event-description="<%= h(event.description.to_s) %>">
      <div class="card-header">
        <h5 class="mb-0"><i class="bi bi-chat-left-text"></i> Reminder Messages</h5>
        <small class="text-muted">These messages will be used for all occurrences unless overridden. Short = Bluesky, Long = Slack/Instagram.</small>
      </div>
      <div class="card-body">
        <div class="alert alert-info py-2 mb-3" role="note">
          <small>
            <i class="bi bi-info-circle" aria-hidden="true"></i>
            <strong>Tip:</strong> Use <code>{{when}}</code> as a placeholder for the date and time. 
            It will be automatically replaced with the actual date/time for each occurrence.
            <br>
            <em>Example: "Join us for <%= event.title %> {{when}} at PDX Hackerspace!"</em>
          </small>
        </div>
        <h6 class="text-muted mb-3">7-Day Reminders</h6>
        <div class="row">
          <div class="col-md-6 mb-3">
            <%= f.label :reminder_7d_short, "Short (#{short_max} chars max)", class: "form-label" %>
            <%= f.text_area :reminder_7d_short, 
                class: "form-control", 
                rows: 4, 
                maxlength: short_max,
                id: "event_reminder_7d_short",
                placeholder: event.reminder_short_default(7),
                data: { default_text: event.reminder_short_default(7) } %>
            <div class="d-flex justify-content-between align-items-center mt-1">
              <small class="text-muted char-count" data-target="event_reminder_7d_short">0/<%=short_max%></small>
              <div class="btn-group btn-group-sm">
                <button type="button" class="btn btn-outline-secondary btn-sm" data-action="set-default" data-target="event_reminder_7d_short">Default</button>
                <% if ollama_configured %>
                  <button type="button" class="btn btn-outline-primary btn-sm" data-action="regenerate" data-target="event_reminder_7d_short" data-type="short"><i class="bi bi-stars"></i> AI</button>
                <% end %>
              </div>
            </div>
          </div>
          <div class="col-md-6 mb-3">
            <%= f.label :reminder_7d_long, "Long (#{long_max} chars max)", class: "form-label" %>
            <%= f.text_area :reminder_7d_long, 
                class: "form-control", 
                rows: 6, 
                maxlength: long_max,
                id: "event_reminder_7d_long",
                placeholder: event.reminder_long_default(7),
                data: { default_text: event.reminder_long_default(7) } %>
            <div class="d-flex justify-content-between align-items-center mt-1">
              <small class="text-muted char-count" data-target="event_reminder_7d_long">0/<%=long_max%></small>
              <div class="btn-group btn-group-sm">
                <button type="button" class="btn btn-outline-secondary btn-sm" data-action="set-default" data-target="event_reminder_7d_long">Default</button>
                <% if ollama_configured %>
                  <button type="button" class="btn btn-outline-primary btn-sm" data-action="regenerate" data-target="event_reminder_7d_long" data-type="long"><i class="bi bi-stars"></i> AI</button>
                <% end %>
              </div>
            </div>
          </div>
        </div>

        <h6 class="text-muted mb-3">1-Day Reminders</h6>
        <div class="row">
          <div class="col-md-6 mb-3">
            <%= f.label :reminder_1d_short, "Short (#{short_max} chars max)", class: "form-label" %>
            <%= f.text_area :reminder_1d_short, 
                class: "form-control", 
                rows: 4, 
                maxlength: short_max,
                id: "event_reminder_1d_short",
                placeholder: event.reminder_short_default(1),
                data: { default_text: event.reminder_short_default(1) } %>
            <div class="d-flex justify-content-between align-items-center mt-1">
              <small class="text-muted char-count" data-target="event_reminder_1d_short">0/<%=short_max%></small>
              <div class="btn-group btn-group-sm">
                <button type="button" class="btn btn-outline-secondary btn-sm" data-action="set-default" data-target="event_reminder_1d_short">Default</button>
                <% if ollama_configured %>
                  <button type="button" class="btn btn-outline-primary btn-sm" data-action="regenerate" data-target="event_reminder_1d_short" data-type="short"><i class="bi bi-stars"></i> AI</button>
                <% end %>
              </div>
            </div>
          </div>
          <div class="col-md-6 mb-3">
            <%= f.label :reminder_1d_long, "Long (#{long_max} chars max)", class: "form-label" %>
            <%= f.text_area :reminder_1d_long, 
                class: "form-control", 
                rows: 6, 
                maxlength: long_max,
                id: "event_reminder_1d_long",
                placeholder: event.reminder_long_default(1),
                data: { default_text: event.reminder_long_default(1) } %>
            <div class="d-flex justify-content-between align-items-center mt-1">
              <small class="text-muted char-count" data-target="event_reminder_1d_long">0/<%=long_max%></small>
              <div class="btn-group btn-group-sm">
                <button type="button" class="btn btn-outline-secondary btn-sm" data-action="set-default" data-target="event_reminder_1d_long">Default</button>
                <% if ollama_configured %>
                  <button type="button" class="btn btn-outline-primary btn-sm" data-action="regenerate" data-target="event_reminder_1d_long" data-type="long"><i class="bi bi-stars"></i> AI</button>
                <% end %>
              </div>
            </div>
          </div>
        </div>

        <% unless ollama_configured %>
          <div class="alert alert-info py-2 mb-0">
            <small><i class="bi bi-info-circle"></i> AI generation is disabled. Configure OLLAMA_SERVER to enable.</small>
          </div>
        <% end %>
      </div>
    </div>
  <% end %>

  <div class="mt-4">
    <%= f.submit class: "btn btn-primary" %>
    <%= link_to "Cancel", events_path, class: "btn btn-secondary" %>
  </div>
<% end %>

<script>
  function initRecurrenceOptions() {
    const recurrenceSelect = document.getElementById('recurrence_type_select');
    const weeklyOptions = document.getElementById('weekly_options');
    const monthlyOptions = document.getElementById('monthly_options');

    if (!recurrenceSelect) return; // Guard in case form not present

    function updateRecurrenceOptions() {
      const value = recurrenceSelect.value;
      
      weeklyOptions.style.display = value === 'weekly' ? 'block' : 'none';
      monthlyOptions.style.display = value === 'monthly' ? 'block' : 'none';
    }

    recurrenceSelect.addEventListener('change', updateRecurrenceOptions);
    updateRecurrenceOptions(); // Run immediately to show correct state
  }

  // Support both Turbo and regular page loads
  document.addEventListener('DOMContentLoaded', initRecurrenceOptions);
  document.addEventListener('turbo:load', initRecurrenceOptions);
  document.addEventListener('turbo:render', initRecurrenceOptions);

  // Reminder message buttons
  function initReminderButtons() {
    const reminderSection = document.getElementById('reminder-messages-section');
    if (!reminderSection) return;

    reminderSection.addEventListener("click", function(event) {
      const button = event.target.closest("[data-action]");
      if (!button) return;
      
      // Prevent any form submission
      event.preventDefault();
      event.stopPropagation();
      
      const targetId = button.dataset.target;
      if (!targetId) return;
      
      const textarea = document.getElementById(targetId);
      if (!textarea) return;

      if (button.dataset.action === "set-default") {
        textarea.value = textarea.dataset.defaultText || "";
        updateCharCount(textarea);
      }

      if (button.dataset.action === "regenerate") {
        generateAiMessageForEvent(button, targetId);
      }
    });
  }

  async function generateAiMessageForEvent(button, targetId) {
    const textarea = document.getElementById(targetId);
    if (!textarea) {
      console.error('Textarea not found:', targetId);
      return;
    }

    const reminderSection = document.getElementById('reminder-messages-section');
    const url = reminderSection?.dataset.generateAiUrl;
    
    if (!url) {
      alert('AI generation is not available. Save the event first to enable AI generation.');
      return;
    }

    const days = targetId.includes('_7d') ? 7 : 1;
    const messageType = button.dataset.type || 'short';
    const originalHTML = button.innerHTML;
    
    // Store reference to reset button state
    const resetButton = () => {
      button.disabled = false;
      button.innerHTML = originalHTML;
    };

    button.disabled = true;
    button.innerHTML = '<span class="spinner-border spinner-border-sm" role="status"></span>';

    try {
      const csrfToken = document.querySelector('meta[name="csrf-token"]')?.content;
      console.log('Generating AI reminder:', { url, days, messageType });
      
      const response = await fetch(url, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Accept': 'application/json',
          'X-CSRF-Token': csrfToken
        },
        body: JSON.stringify({ days: days, type: messageType })
      });

      console.log('AI response status:', response.status);
      
      if (!response.ok) {
        const errorText = await response.text();
        console.error('AI generation error response:', errorText);
        alert(`AI generation failed (${response.status}). Check console for details.`);
        resetButton();
        return;
      }

      const data = await response.json();
      console.log('AI response data:', data);
      
      if (data.success) {
        textarea.value = data.message;
        textarea.classList.add("is-valid");
        updateCharCount(textarea);
        setTimeout(() => textarea.classList.remove("is-valid"), 2000);
      } else {
        alert(`AI generation failed: ${data.message}`);
      }
    } catch (error) {
      console.error('Error generating AI reminder:', error);
      alert('An error occurred during AI generation. Please try again.');
    }
    
    // Always reset button state
    resetButton();
  }

  // Character count for textareas
  function updateCharCount(textarea) {
    const countEl = document.querySelector(`.char-count[data-target="${textarea.id}"]`);
    if (countEl) {
      const max = textarea.maxLength;
      const current = textarea.value.length;
      countEl.textContent = `${current}/${max}`;
      countEl.classList.toggle('text-danger', current > max * 0.9);
    }
  }

  function initCharCounts() {
    document.querySelectorAll('textarea[maxlength]').forEach(textarea => {
      updateCharCount(textarea);
      textarea.addEventListener('input', () => updateCharCount(textarea));
    });
  }

  document.addEventListener('DOMContentLoaded', initReminderButtons);
  document.addEventListener('turbo:load', initReminderButtons);
  document.addEventListener('DOMContentLoaded', initCharCounts);
  document.addEventListener('turbo:load', initCharCounts);
</script>

