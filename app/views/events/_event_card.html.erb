<article class="card h-100 <%= 'border-warning' if event.status == 'postponed' %> <%= 'border-danger' if event.status == 'cancelled' %>" aria-labelledby="event-title-<%= event.id %>">
  <% if event.banner_image.attached? %>
    <%= link_to event_path(event), "aria-label": "View #{event.title}" do %>
      <%= image_tag event.banner_image, class: "card-img-top", style: "max-height: 200px; object-fit: cover; cursor: pointer;", alt: "Banner image for #{event.title}", loading: "lazy" %>
    <% end %>
  <% end %>
  <div class="card-body">
    <div class="d-flex justify-content-between align-items-start mb-2">
      <h2 class="card-title h5" id="event-title-<%= event.id %>">
        <%= link_to event.title, event_path(event), class: "text-decoration-none text-body" %>
      </h2>
      <div>
        <% if event.draft? %>
          <span class="badge bg-secondary me-1">
            <i class="bi bi-file-earmark-text" aria-hidden="true"></i> Draft
          </span>
        <% end %>
        <% if event.status != 'active' %>
          <span class="badge bg-<%= event.status == 'postponed' ? 'warning' : 'danger' %>">
            <%= event.status.titleize %>
          </span>
        <% end %>
      </div>
    </div>
    
    <% if event.status != 'active' && event.cancellation_reason.present? %>
      <div class="alert alert-<%= event.status == 'postponed' ? 'warning' : 'danger' %> py-2 small mb-2">
        <strong>Reason:</strong> <%= truncate(event.cancellation_reason, length: 80) %>
      </div>
    <% end %>
    
    <p class="card-text"><%= truncate(event.description, length: 120) %></p>
    
    <div class="text-muted small">
      <%
        # Get the next upcoming occurrence for this event, or fall back to start_time
        next_occurrence = defined?(@next_occurrence_by_event) && @next_occurrence_by_event[event.id] ? @next_occurrence_by_event[event.id] : nil
        display_date = next_occurrence ? next_occurrence.occurs_at : event.start_time
        display_duration = next_occurrence ? next_occurrence.duration : event.duration
      %>
      <% if next_occurrence && next_occurrence.status == 'postponed' && next_occurrence.postponed_until %>
        <p class="mb-1">
          <i class="bi bi-calendar-x" aria-hidden="true"></i> 
          <span class="text-decoration-line-through"><%= next_occurrence.occurs_at.strftime('%B %d, %Y') %></span>
          <span class="visually-hidden">(original date, now postponed)</span>
        </p>
        <p class="mb-1 text-warning fw-bold">
          <i class="bi bi-calendar-check" aria-hidden="true"></i> <%= next_occurrence.postponed_until.strftime('%B %d, %Y') %> (Rescheduled)
        </p>
        <p class="mb-1">
          <i class="bi bi-clock" aria-hidden="true"></i>
          <span class="visually-hidden">Time:</span>
          <%= next_occurrence.postponed_until.strftime('%I:%M %p') %> to <%= (next_occurrence.postponed_until + display_duration.minutes).strftime('%I:%M %p') %>
        </p>
      <% else %>
        <p class="mb-1">
          <i class="bi bi-calendar" aria-hidden="true"></i>
          <span class="visually-hidden">Date:</span>
          <%= display_date.strftime('%B %d, %Y') %>
        </p>
        <p class="mb-1">
          <i class="bi bi-clock" aria-hidden="true"></i>
          <span class="visually-hidden">Time:</span>
          <%= display_date.strftime('%I:%M %p') %> to <%= (display_date + display_duration.minutes).strftime('%I:%M %p') %>
        </p>
      <% end %>
      <p class="mb-1">
        <i class="bi bi-person" aria-hidden="true"></i>
        <span class="visually-hidden">Hosted by:</span>
        <%= event.hosts.map { |h| h.name || h.email }.join(', ') %>
      </p>
      <% if event.recurring? %>
        <p class="mb-1">
          <i class="bi bi-arrow-repeat" aria-hidden="true"></i>
          <span class="visually-hidden">Recurrence:</span>
          <%= event.recurrence_type.titleize %>
        </p>
      <% end %>
      <p class="mb-0">
      <% 
        open_to_text = case event.open_to
        when 'public' then 'Open to All'
        when 'members' then 'Members Only'
        when 'private' then 'Private'
        end
      %>
        <span class="badge bg-secondary">
          <i class="bi bi-<%= event.open_to == 'public' ? 'door-open' : (event.open_to == 'members' ? 'people-fill' : 'envelope') %>" aria-hidden="true"></i>
          <%= open_to_text %>
        </span>
        <% if event.requires_mask %>
          <span class="badge bg-info">
            <i class="bi bi-shield-fill-check" aria-hidden="true"></i> Masks Required
          </span>
        <% end %>
      </p>
    </div>
  </div>
  
  <footer class="card-footer d-flex justify-content-between align-items-center flex-wrap gap-2">
    <div>
      <%= link_to "View Details", event_path(event), class: "btn btn-sm btn-primary" %>
      <% if event.more_info_url.present? %>
        <%= link_to event.more_info_url, target: "_blank", rel: "noopener", class: "btn btn-sm btn-outline-info", "aria-label": "Learn more about #{event.title} (opens in new tab)" do %>
          <i class="bi bi-link-45deg" aria-hidden="true"></i>
          <span class="visually-hidden">External link</span>
        <% end %>
      <% end %>
    </div>
    <div class="d-flex gap-1">
      <% if next_occurrence %>
        <div class="btn-group" role="group" aria-label="Add to calendar for <%= event.title %>">
          <%= link_to google_calendar_url(next_occurrence), target: "_blank", rel: "noopener", class: "btn btn-sm btn-outline-primary", title: "Add to Google Calendar", "aria-label": "Add #{event.title} to Google Calendar" do %>
            <i class="bi bi-google" aria-hidden="true"></i>
          <% end %>
          <%= link_to apple_calendar_url(next_occurrence), class: "btn btn-sm btn-outline-secondary", title: "Add to Apple Calendar", "aria-label": "Add #{event.title} to Apple Calendar" do %>
            <i class="bi bi-apple" aria-hidden="true"></i>
          <% end %>
          <%= link_to outlook_calendar_url(next_occurrence), target: "_blank", rel: "noopener", class: "btn btn-sm btn-outline-primary", title: "Add to Outlook", "aria-label": "Add #{event.title} to Outlook Calendar" do %>
            <i class="bi bi-microsoft" aria-hidden="true"></i>
          <% end %>
        </div>
      <% end %>
      <div class="btn-group" role="group" aria-label="Subscribe options for <%= event.title %>">
        <%= link_to rss_event_path(event, format: :rss), class: "btn btn-sm btn-outline-warning", title: "RSS Feed", "aria-label": "RSS feed for #{event.title}" do %>
          <i class="bi bi-rss" aria-hidden="true"></i>
        <% end %>
        <%= link_to event_ical_path(event.ical_token, format: :ics), class: "btn btn-sm btn-outline-secondary", title: "iCal Feed", "aria-label": "iCal feed for #{event.title}" do %>
          <i class="bi bi-calendar-plus" aria-hidden="true"></i>
        <% end %>
      </div>
    </div>
  </footer>
</article>

