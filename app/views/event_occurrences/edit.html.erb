<div class="row">
  <div class="col-lg-8 mx-auto">
    <nav aria-label="breadcrumb">
      <ol class="breadcrumb">
        <li class="breadcrumb-item"><%= link_to "Events", events_path %></li>
        <li class="breadcrumb-item"><%= link_to @event.title, event_path(@event) %></li>
        <li class="breadcrumb-item"><%= link_to @occurrence.occurs_at.strftime('%b %d'), event_occurrence_path(@occurrence) %></li>
        <li class="breadcrumb-item active">Edit</li>
      </ol>
    </nav>

    <h1 class="mb-4">Edit Occurrence</h1>
    <h5 class="text-muted mb-4"><%= @occurrence.occurs_at.strftime('%A, %B %d, %Y at %I:%M %p') %></h5>

    <div class="card">
      <div class="card-body">
        <%= form_with(model: @occurrence, url: event_occurrence_path(@occurrence), method: :patch, local: true) do |f| %>
          <% if @occurrence.errors.any? %>
            <div class="alert alert-danger">
              <h4><%= pluralize(@occurrence.errors.count, "error") %> prohibited this occurrence from being saved:</h4>
              <ul>
                <% @occurrence.errors.full_messages.each do |message| %>
                  <li><%= message %></li>
                <% end %>
              </ul>
            </div>
          <% end %>

          <div class="alert alert-info">
            <strong>Note:</strong> Changes here only affect this specific occurrence on <%= @occurrence.occurs_at.strftime('%B %d, %Y') %>.
            To change all future occurrences, <%= link_to "edit the event series", edit_event_path(@event) %>.
          </div>

          <div class="mb-3">
            <%= f.label :custom_description, "Custom Description (Optional)", class: "form-label" %>
            <%= f.text_area :custom_description, class: "form-control", rows: 5, 
                placeholder: "Leave blank to use the event's default description..." %>
            <small class="form-text text-muted">
              Override the event description for this specific occurrence
            </small>
          </div>

          <div class="mb-3">
            <%= f.label :duration_override, "Custom Duration (Optional)", class: "form-label" %>
            <%= f.number_field :duration_override, class: "form-control", 
                placeholder: "Default: #{@event.duration} minutes", min: 15, step: 15 %>
            <small class="form-text text-muted">
              Override the event duration for this occurrence (in minutes)
            </small>
          </div>

          <div class="mb-3">
            <%= f.label :location_id, "Location Override (Optional)", class: "form-label" %>
            <%= f.collection_select :location_id, Location.alphabetical, :id, :name,
                { prompt: @event.location ? "Default: #{@event.location.name}" : "No specific location", include_blank: true },
                class: "form-select" %>
            <small class="form-text text-muted">
              <i class="bi bi-geo-alt"></i> Override the event's default location for this occurrence
            </small>
          </div>

          <% ai_enabled = OllamaService.configured? %>
          <% site_config = SiteConfig.current %>
          <% show_notifications = site_config.slack_enabled? || site_config.social_reminders_enabled? %>
          <% short_max = site_config.short_reminder_max_length %>
          <% long_max = site_config.long_reminder_max_length %>
          <% if show_notifications %>
            <div class="card mb-4 border-info" id="ai-reminder-card"
                 data-generate-url="<%= generate_ai_reminder_event_occurrence_path(@occurrence) %>">
            <div class="card-body">
                <h5 class="card-title mb-3">Reminder Messages</h5>
                <small class="text-muted d-block mb-3">Short = Bluesky (<%=short_max%> chars), Long = Slack/Instagram (<%=long_max%> chars). Leave blank to inherit from event.</small>
                <div id="ai-notification" class="alert d-none mb-3" role="alert"></div>
                
                <% [7, 1].each do |days| %>
                  <h6 class="text-muted mb-2"><%= days %>-Day Reminders</h6>
                  <div class="row mb-3">
                    <div class="col-md-6">
                      <% field_short = "reminder_#{days}d_short".to_sym %>
                      <%= label_tag field_short, "Short", class: "form-label" %>
                      <%= text_area_tag "event_occurrence[#{field_short}]", @occurrence.public_send(field_short), 
                          id: field_short.to_s, class: "form-control", rows: 2, maxlength: short_max,
                          placeholder: @occurrence.reminder_short_default(days),
                          data: { default_text: @occurrence.reminder_short_default(days), days: days } %>
                      <div class="d-flex justify-content-between align-items-center mt-1">
                        <small class="text-muted char-count" data-target="<%= field_short %>">0/<%=short_max%></small>
                        <div class="btn-group btn-group-sm">
                          <button type="button" class="btn btn-outline-secondary btn-sm" data-action="set-default" data-target="<%= field_short %>">Default</button>
                          <% if ai_enabled %>
                            <button type="button" class="btn btn-outline-primary btn-sm" data-action="generate-ai" data-target="<%= field_short %>" data-days="<%= days %>" data-type="short">
                              <span class="btn-text"><i class="bi bi-stars"></i> AI</span>
                              <span class="spinner-border spinner-border-sm d-none" role="status"></span>
                            </button>
                          <% end %>
                        </div>
                      </div>
                    </div>
                    <div class="col-md-6">
                      <% field_long = "reminder_#{days}d_long".to_sym %>
                      <%= label_tag field_long, "Long", class: "form-label" %>
                      <%= text_area_tag "event_occurrence[#{field_long}]", @occurrence.public_send(field_long), 
                          id: field_long.to_s, class: "form-control", rows: 2, maxlength: long_max,
                          placeholder: @occurrence.reminder_long_default(days),
                          data: { default_text: @occurrence.reminder_long_default(days), days: days } %>
                      <div class="d-flex justify-content-between align-items-center mt-1">
                        <small class="text-muted char-count" data-target="<%= field_long %>">0/<%=long_max%></small>
                        <div class="btn-group btn-group-sm">
                          <button type="button" class="btn btn-outline-secondary btn-sm" data-action="set-default" data-target="<%= field_long %>">Default</button>
                          <% if ai_enabled %>
                            <button type="button" class="btn btn-outline-primary btn-sm" data-action="generate-ai" data-target="<%= field_long %>" data-days="<%= days %>" data-type="long">
                              <span class="btn-text"><i class="bi bi-stars"></i> AI</span>
                              <span class="spinner-border spinner-border-sm d-none" role="status"></span>
                            </button>
                          <% end %>
                        </div>
                      </div>
                    </div>
                  </div>
                <% end %>
                
                <% unless ai_enabled %>
                  <div class="alert alert-info py-2 mb-0">
                    <small><i class="bi bi-info-circle"></i> Set <code>OLLAMA_SERVER</code> to enable AI generation.</small>
                  </div>
                <% end %>
            </div>
          </div>

          <% if SiteConfig.current.slack_enabled? || SiteConfig.current.social_reminders_enabled? %>
            <div class="card mb-4 border-secondary">
              <div class="card-body">
                <h5 class="card-title mb-3">Manual Reminders</h5>
                <div id="reminder-notification" class="alert d-none mb-3" role="alert"></div>
                <% site_config = SiteConfig.current %>
                <% slack_disabled = !site_config.slack_enabled? || !@event.slack_announce? %>
                <% social_disabled = !site_config.social_reminders_enabled? || !@event.social_reminders? %>
                <div class="mb-3">
                  <button type="button" class="btn btn-warning me-2" id="post-slack-btn"
                          data-post-url="<%= post_slack_reminder_event_occurrence_path(@occurrence) %>"
                          <%= 'disabled' if slack_disabled %>>
                    <span class="btn-text">Post to Slack now</span>
                    <span class="spinner-border spinner-border-sm d-none" role="status"></span>
                  </button>
                  <button type="button" class="btn btn-info" id="post-social-btn"
                          data-post-url="<%= post_social_reminder_event_occurrence_path(@occurrence) %>"
                          <%= 'disabled' if social_disabled %>>
                    <span class="btn-text">Post to Social Media now</span>
                    <span class="spinner-border spinner-border-sm d-none" role="status"></span>
                  </button>
                </div>
                <% unless site_config.slack_enabled? %>
                  <p class="text-muted mb-0"><i class="bi bi-slack"></i> Enable Slack reminders in Site Config to post now.</p>
                <% end %>
                <% unless site_config.social_reminders_enabled? %>
                  <p class="text-muted mb-0"><i class="bi bi-share"></i> Enable social reminders in Site Config to post now.</p>
                <% end %>
              </div>
            </div>
          <% end %>
        <% end %>

          <div class="mb-3">
            <%= f.label :banner_image, "Custom Banner Image (Optional)", class: "form-label" %>
            <%= f.file_field :banner_image, class: "form-control", accept: "image/*" %>
            <small class="form-text text-muted">
              <i class="bi bi-image"></i> Recommended: 1200x400 pixels or similar 3:1 aspect ratio. Maximum file size: 5MB. Upload a custom banner for this occurrence, or leave blank to use the event's banner
            </small>
            <% if @occurrence.banner_image.attached? %>
              <div class="mt-2">
                <strong>Current custom banner:</strong><br>
                <%= image_tag @occurrence.banner_image, class: "img-thumbnail", style: "max-width: 300px;" %>
                <div class="form-check mt-2">
                  <%= f.check_box :remove_banner_image, class: "form-check-input" %>
                  <%= f.label :remove_banner_image, "Remove custom banner (use event's banner)", class: "form-check-label" %>
                </div>
              </div>
            <% elsif @event.banner_image.attached? %>
              <div class="mt-2">
                <strong>Currently using event's banner:</strong><br>
                <%= image_tag @event.banner_image, class: "img-thumbnail", style: "max-width: 300px; opacity: 0.7;" %>
              </div>
            <% end %>
          </div>

          <div class="mt-4">
            <%= f.submit "Update Occurrence", class: "btn btn-primary" %>
            <%= link_to "Cancel", event_occurrence_path(@occurrence), class: "btn btn-secondary" %>
          </div>
        <% end %>
      </div>
    </div>
  </div>
</div>

<script>
  document.addEventListener("click", function(event) {
    const button = event.target.closest("[data-action]");
    if (!button) return;
    const targetId = button.dataset.target;
    if (!targetId) return;
    const textarea = document.getElementById(targetId);
    if (!textarea) return;

    if (button.dataset.action === "set-default") {
      textarea.value = textarea.dataset.defaultText || "";
    }

    if (button.dataset.action === "generate-ai") {
      generateAiReminder(button, textarea);
    }
  });

  async function generateAiReminder(button, textarea) {
    const aiCard = document.getElementById('ai-reminder-card');
    const generateUrl = aiCard?.dataset.generateUrl;
    const days = button.dataset.days;
    const messageType = button.dataset.type || 'short';
    
    if (!generateUrl) {
      showAiNotification('AI generation URL not found.', false);
      return;
    }

    const btnText = button.querySelector('.btn-text');
    const spinner = button.querySelector('.spinner-border');
    const originalHTML = btnText.innerHTML;

    // Show loading state
    button.disabled = true;
    btnText.innerHTML = '';
    spinner.classList.remove('d-none');

    try {
      const csrfToken = document.querySelector('meta[name="csrf-token"]')?.content;
      const response = await fetch(generateUrl, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Accept': 'application/json',
          'X-CSRF-Token': csrfToken
        },
        body: JSON.stringify({ days: parseInt(days), type: messageType })
      });

      const data = await response.json();
      
      if (data.success) {
        textarea.value = data.message;
        textarea.classList.add('border-success');
        updateCharCount(textarea);
        setTimeout(() => textarea.classList.remove('border-success'), 2000);
        showAiNotification('AI reminder generated successfully!', true);
      } else {
        showAiNotification(data.message || 'Failed to generate AI reminder.', false);
      }
    } catch (error) {
      console.error('Error generating AI reminder:', error);
      showAiNotification('An error occurred while generating. Please try again.', false);
    } finally {
      button.disabled = false;
      btnText.innerHTML = originalHTML;
      spinner.classList.add('d-none');
    }
  }
  
  // Character count for textareas
  function updateCharCount(textarea) {
    const countEl = document.querySelector(`.char-count[data-target="${textarea.id}"]`);
    if (countEl) {
      const max = textarea.maxLength;
      const current = textarea.value.length;
      countEl.textContent = `${current}/${max}`;
      countEl.classList.toggle('text-danger', current > max * 0.9);
    }
  }

  // Initialize character counts
  document.querySelectorAll('textarea[maxlength]').forEach(textarea => {
    updateCharCount(textarea);
    textarea.addEventListener('input', () => updateCharCount(textarea));
  });

  function showAiNotification(message, isSuccess) {
    const notification = document.getElementById('ai-notification');
    if (!notification) return;
    
    notification.textContent = message;
    notification.className = `alert ${isSuccess ? 'alert-success' : 'alert-danger'} mb-3`;
    notification.classList.remove('d-none');
    
    if (isSuccess) {
      setTimeout(() => notification.classList.add('d-none'), 5000);
    }
  }

  // Post to Slack/Social Media buttons - async with inline notification
  function showNotification(message, isSuccess) {
    const notification = document.getElementById('reminder-notification');
    if (!notification) return;
    
    notification.textContent = message;
    notification.className = `alert ${isSuccess ? 'alert-success' : 'alert-danger'} mb-3`;
    notification.classList.remove('d-none');
    
    // Auto-hide success messages after 5 seconds
    if (isSuccess) {
      setTimeout(() => notification.classList.add('d-none'), 5000);
    }
  }

  async function postReminder(button) {
    const url = button.dataset.postUrl;
    if (!url) return;

    const btnText = button.querySelector('.btn-text');
    const spinner = button.querySelector('.spinner-border');
    const originalText = btnText.textContent;

    // Show loading state
    button.disabled = true;
    btnText.textContent = 'Posting...';
    spinner.classList.remove('d-none');

    try {
      const csrfToken = document.querySelector('meta[name="csrf-token"]')?.content;
      const response = await fetch(url, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Accept': 'application/json',
          'X-CSRF-Token': csrfToken
        }
      });

      const data = await response.json();
      showNotification(data.message, data.success);
    } catch (error) {
      console.error('Error posting reminder:', error);
      showNotification('An error occurred while posting. Please try again.', false);
    } finally {
      // Restore button state
      button.disabled = false;
      btnText.textContent = originalText;
      spinner.classList.add('d-none');
    }
  }

  document.getElementById('post-slack-btn')?.addEventListener('click', function(e) {
    e.preventDefault();
    postReminder(this);
  });

  document.getElementById('post-social-btn')?.addEventListener('click', function(e) {
    e.preventDefault();
    postReminder(this);
  });
</script>
