<div class="d-flex justify-content-between align-items-center mb-4">
  <h1><i class="bi bi-journal-text"></i> Activity Journal</h1>
</div>

<div class="alert alert-info">
  <i class="bi bi-info-circle"></i> This log shows all changes made to events and occurrences across the system.
</div>

<% if @journals.any? %>
  <div class="table-responsive">
    <table class="table table-striped table-hover">
      <thead class="table-dark">
        <tr>
          <th>Date/Time</th>
          <th>User</th>
          <th>Event</th>
          <th>Action</th>
          <th>Details</th>
        </tr>
      </thead>
      <tbody>
        <% @journals.each do |journal| %>
          <tr>
            <td>
              <small><%= journal.created_at.strftime('%Y-%m-%d %H:%M') %></small>
            </td>
            <td>
              <% if journal.user %>
                <%= journal.user.name || journal.user.email %>
              <% else %>
                <span class="text-muted">(deleted user)</span>
              <% end %>
            </td>
            <td>
              <% if journal.event %>
                <%= link_to journal.event.title, event_path(journal.event), class: "text-decoration-none" %>
              <% elsif journal.change_data&.dig('title') %>
                <span class="text-muted"><%= journal.change_data['title'] %> (deleted)</span>
              <% else %>
                <span class="text-muted">(deleted event)</span>
              <% end %>
              <% if journal.occurrence_id %>
                <br>
                <small class="text-muted">
                  <i class="bi bi-calendar-event"></i>
                  <% if journal.occurrence %>
                    <%= link_to journal.occurrence.occurs_at.strftime('%b %d, %Y'), event_occurrence_path(journal.occurrence), class: "text-decoration-none" %>
                  <% else %>
                    (deleted occurrence)
                  <% end %>
                </small>
              <% end %>
            </td>
            <td>
              <% 
                badge_class = case journal.action
                when 'created' then 'bg-success'
                when 'updated' then 'bg-primary'
                when 'deleted' then 'bg-danger'
                when 'cancelled' then 'bg-warning text-dark'
                when 'postponed' then 'bg-warning text-dark'
                when 'reactivated' then 'bg-info'
                when 'host_added', 'host_removed' then 'bg-secondary'
                when 'banner_added', 'banner_removed' then 'bg-info'
                else 'bg-secondary'
                end
              %>
              <span class="badge <%= badge_class %>"><%= journal.action.titleize %></span>
            </td>
            <td>
              <small><%= journal.summary %></small>
              <% if journal.change_data.present? && journal.action == 'updated' %>
                <br>
                <small class="text-muted">
                  Changed: <%= journal.change_data.keys.map(&:titleize).join(', ') %>
                </small>
              <% end %>
            </td>
          </tr>
        <% end %>
      </tbody>
    </table>
  </div>

  <nav aria-label="Journal pagination">
    <ul class="pagination justify-content-center">
      <li class="page-item <%= 'disabled' unless @has_prev_page %>">
        <%= link_to event_journals_path(page: @page - 1), class: "page-link", "aria-label": "Previous" do %>
          <span aria-hidden="true">&laquo;</span> Previous
        <% end %>
      </li>
      <li class="page-item disabled">
        <span class="page-link">Page <%= @page %></span>
      </li>
      <li class="page-item <%= 'disabled' unless @has_next_page %>">
        <%= link_to event_journals_path(page: @page + 1), class: "page-link", "aria-label": "Next" do %>
          Next <span aria-hidden="true">&raquo;</span>
        <% end %>
      </li>
    </ul>
  </nav>
<% else %>
  <div class="alert alert-secondary">
    <p class="mb-0">No journal entries recorded yet.</p>
  </div>
<% end %>
