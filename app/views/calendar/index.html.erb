<%# SEO Meta Tags %>
<% page_title "Calendar" %>
<% page_description "View the event calendar for #{@site_config&.organization_name || 'our hackerspace'}. Find workshops, meetups, and community events." %>
<% canonical_url calendar_url %>

<%# Breadcrumb JSON-LD %>
<% content_for :json_ld do %>
  <script type="application/ld+json"><%= breadcrumb_json_ld([
    { name: 'Home', url: root_url },
    { name: 'Calendar', url: calendar_url }
  ]) %></script>
<% end %>

<div class="d-flex justify-content-between align-items-center mb-4">
  <h1><i class="bi bi-calendar3"></i> Event Calendar</h1>
  <div>
    <%= link_to calendar_ical_path, class: "btn btn-outline-primary me-2", title: "Subscribe to Calendar" do %>
      <i class="bi bi-calendar-plus"></i> Subscribe (.ics)
    <% end %>
    <button type="button" class="btn btn-outline-info me-2" data-bs-toggle="modal" data-bs-target="#embedModal">
      <i class="bi bi-code-square"></i> Embed
    </button>
    <%= link_to "Events View", events_path, class: "btn btn-outline-secondary" %>
  </div>
</div>

<div class="d-flex justify-content-between align-items-center mb-3">
  <p class="lead mb-0">
    <% if @view == 'calendar' %>
      <%= @current_month.strftime('%B %Y') %>
    <% else %>
      Showing <%= @occurrences.count %> upcoming event occurrences
    <% end %>
    <small class="text-muted">· <%= link_to "Subscribe to calendar feed", calendar_ical_path, class: "text-decoration-none" %></small>
  </p>
  
  <div class="btn-group" role="group" aria-label="View selector">
    <%= link_to calendar_path(view: 'calendar'), class: "btn btn-sm #{@view == 'calendar' ? 'btn-primary' : 'btn-outline-primary'}" do %>
      <i class="bi bi-calendar3"></i> Calendar
    <% end %>
    <%= link_to calendar_path(view: 'list'), class: "btn btn-sm #{@view == 'list' ? 'btn-primary' : 'btn-outline-primary'}" do %>
      <i class="bi bi-list-ul"></i> List
    <% end %>
  </div>
</div>

<% if @view == 'calendar' %>
  <%= render 'calendar_grid' %>
<% elsif @occurrences_by_month.any? %>
  <% @occurrences_by_month.sort.each do |month, occurrences| %>
    <div class="card mb-4">
      <div class="card-header bg-primary text-white">
        <h4 class="mb-0"><%= month.strftime('%B %Y') %></h4>
      </div>
      <div class="list-group list-group-flush">
        <% occurrences.each do |occurrence| %>
          <div class="list-group-item <%= 'list-group-item-warning' if occurrence.status == 'postponed' %> <%= 'list-group-item-danger' if occurrence.status == 'cancelled' %>">
            <div class="row align-items-center">
              <% if occurrence.banner.attached? %>
                <div class="col-md-2 text-center">
                  <%= link_to event_occurrence_path(occurrence) do %>
                    <%= image_tag occurrence.banner, class: "img-thumbnail", style: "max-width: 100px; max-height: 100px; object-fit: cover; cursor: pointer;" %>
                  <% end %>
                </div>
              <% end %>
              <div class="<%= occurrence.banner.attached? ? 'col-md-2' : 'col-md-2 offset-md-2' %>">
                <div class="text-center">
                  <div class="display-6"><%= occurrence.occurs_at.day %></div>
                  <div class="text-muted"><%= occurrence.occurs_at.strftime('%a') %></div>
                </div>
              </div>
              <div class="col-md-5">
                <h5 class="mb-1">
                  <%= link_to occurrence.event.title, event_path(occurrence.event), class: "text-decoration-none" %>
                  <% if occurrence.status != 'active' %>
                    <span class="badge bg-<%= occurrence.status == 'postponed' ? 'warning' : 'danger' %>">
                      <%= occurrence.status.titleize %>
                    </span>
                  <% end %>
                </h5>
                <p class="mb-1 text-muted">
                  <i class="bi bi-clock"></i> <%= occurrence.occurs_at.strftime('%I:%M %p') %> to <%= (occurrence.occurs_at + occurrence.duration.minutes).strftime('%I:%M %p') %>
                  ·
                  <i class="bi bi-person"></i> <%= occurrence.event.hosts.map { |h| h.name || h.email }.join(', ') %>
                </p>
                <% if occurrence.status == 'postponed' && occurrence.postponed_until %>
                  <p class="mb-1"><strong>Rescheduled to:</strong> <%= occurrence.postponed_until.strftime('%B %d, %Y at %I:%M %p') %></p>
                <% end %>
                <% if occurrence.cancellation_reason.present? %>
                  <p class="mb-1"><strong>Reason:</strong> <%= occurrence.cancellation_reason %></p>
                <% end %>
                <p class="mb-0">
                  <span class="badge bg-secondary">
                    <i class="bi bi-<%= occurrence.event.open_to == 'public' ? 'door-open' : (occurrence.event.open_to == 'members' ? 'people-fill' : 'envelope') %>"></i>
                    <%= occurrence.event.open_to == 'public' ? 'Open to All' : (occurrence.event.open_to == 'members' ? 'Members Only' : 'Private') %>
                  </span>
                  <% if occurrence.event.requires_mask %>
                    <span class="badge bg-info">
                      <i class="bi bi-shield-fill-check"></i> Masks Required
                    </span>
                  <% end %>
                </p>
              </div>
              <div class="col-md-3 text-end">
                <%= link_to "View Event", event_path(occurrence.event), class: "btn btn-sm btn-outline-primary mb-1 w-100" %>
                <%= link_to "View Occurrence", event_occurrence_path(occurrence), class: "btn btn-sm btn-primary w-100" %>
              </div>
            </div>
          </div>
        <% end %>
      </div>
    </div>
  <% end %>
<% else %>
  <div class="alert alert-info">
    <p class="mb-0">No upcoming event occurrences scheduled.</p>
  </div>
<% end %>

<!-- Embed Modal -->
<div class="modal fade" id="embedModal" tabindex="-1" aria-labelledby="embedModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="embedModalLabel"><i class="bi bi-code-square"></i> Embed Calendar</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <p>Embed the event calendar on your website using the code below:</p>

        <div class="mb-3">
          <label class="form-label fw-bold">HTML Embed Code:</label>
          <textarea class="form-control font-monospace small" rows="4" readonly onclick="this.select()"><iframe src="<%= calendar_embed_url %>" width="100%" height="800" frameborder="0" style="border: 1px solid #dee2e6; border-radius: 0.25rem;"></iframe></textarea>
          <small class="form-text text-muted">Click to select all, then copy and paste into your website</small>
        </div>

        <div class="mb-3">
          <label class="form-label fw-bold">Direct Link:</label>
          <div class="input-group">
            <input type="text" class="form-control font-monospace small" value="<%= calendar_embed_url %>" readonly onclick="this.select()">
            <%= link_to "Open", calendar_embed_path, class: "btn btn-outline-primary", target: "_blank" %>
          </div>
        </div>

        <div class="alert alert-info small">
          <strong>Features:</strong>
          <ul class="mb-0">
            <li>Default view: Calendar grid</li>
            <li>Users can toggle between Calendar and List views</li>
            <li>Shows all public events</li>
            <li>Responsive design works on all devices</li>
          </ul>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
        <%= link_to "Preview Embed", calendar_embed_path, class: "btn btn-primary", target: "_blank" %>
      </div>
    </div>
  </div>
</div>
