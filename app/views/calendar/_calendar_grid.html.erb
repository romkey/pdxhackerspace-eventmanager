<nav class="calendar-navigation mb-3" aria-label="Calendar navigation">
  <div class="d-flex justify-content-between align-items-center">
    <% path_helper = @embed ? :calendar_embed_path : :calendar_path %>
    <%= link_to send(path_helper, view: 'calendar', month: (@current_month - 1.month).strftime('%Y-%m-%d')), class: "btn btn-outline-primary", "aria-label": "Previous month: #{(@current_month - 1.month).strftime('%B %Y')}" do %>
      <i class="bi bi-chevron-left" aria-hidden="true"></i> <%= (@current_month - 1.month).strftime('%B %Y') %>
    <% end %>
    
    <h2 class="mb-0 h3" id="calendar-heading"><%= @current_month.strftime('%B %Y') %></h2>
    
    <%= link_to send(path_helper, view: 'calendar', month: (@current_month + 1.month).strftime('%Y-%m-%d')), class: "btn btn-outline-primary", "aria-label": "Next month: #{(@current_month + 1.month).strftime('%B %Y')}" do %>
      <%= (@current_month + 1.month).strftime('%B %Y') %> <i class="bi bi-chevron-right" aria-hidden="true"></i>
    <% end %>
  </div>
</nav>

<div class="calendar-grid" role="grid" aria-labelledby="calendar-heading">
  <div class="calendar-header" role="row">
    <% Date::DAYNAMES.each do |day| %>
      <div class="calendar-day-header" role="columnheader"><%= day %></div>
    <% end %>
  </div>
  
  <div class="calendar-body" role="rowgroup">
    <% calendar_start = @current_month.beginning_of_month.beginning_of_week(:sunday) %>
    <% calendar_end = @current_month.end_of_month.end_of_week(:sunday) %>
    <% (calendar_start..calendar_end).each do |date| %>
      <div class="calendar-cell <%= 'other-month' unless date.month == @current_month.month %> <%= 'today' if date == Date.current %>" role="gridcell" aria-label="<%= date.strftime('%B %d, %Y') %><%= ', Today' if date == Date.current %>">
        <div class="calendar-date-number" aria-hidden="true"><%= date.day %></div>
        <% if @occurrences_by_date[date].present? %>
          <div class="calendar-events">
            <% @occurrences_by_date[date].each do |occurrence| %>
              <% 
                badge_class = case occurrence.status
                when 'postponed' then 'bg-warning text-dark'
                when 'cancelled' then 'bg-danger text-white'
                else 'bg-primary text-white'
                end
              %>
              <%= link_to event_occurrence_path(occurrence), class: "calendar-event-item text-decoration-none", target: "_blank", rel: "noopener", "aria-label": "#{occurrence.event.title} at #{occurrence.occurs_at.strftime('%I:%M %p')}#{occurrence.status != 'active' ? " (#{occurrence.status})" : ''}" do %>
                <div class="calendar-event-badge <%= badge_class %>">
                  <div class="event-time"><%= occurrence.occurs_at.strftime('%I:%M %p') %></div>
                  <div class="event-title">
                    <% if occurrence.event.requires_mask %>
                      <i class="bi bi-shield-fill-check" aria-hidden="true"></i>
                      <span class="visually-hidden">Masks required</span>
                    <% end %>
                    <%= truncate(occurrence.event.title, length: 30) %>
                    <% if occurrence.status == 'postponed' && occurrence.postponed_until %>
                      <%
                        new_occurrence = occurrence.event.occurrences.find_by(
                          occurs_at: occurrence.postponed_until,
                          status: 'active'
                        )
                      %>
                      <div class="fw-bold mt-1" style="font-size: 0.65rem;">
                        <% if new_occurrence %>
                          <%= link_to event_occurrence_path(new_occurrence), class: "text-reset", target: "_blank", rel: "noopener" do %>
                            POSTPONED to <%= occurrence.postponed_until.strftime('%b %d') %>
                          <% end %>
                        <% else %>
                          POSTPONED to <%= occurrence.postponed_until.strftime('%b %d') %>
                        <% end %>
                      </div>
                    <% elsif occurrence.status == 'cancelled' %>
                      <div class="fw-bold mt-1" style="font-size: 0.65rem;">
                        CANCELLED
                      </div>
                    <% end %>
                  </div>
                </div>
              <% end %>
            <% end %>
          </div>
        <% end %>
      </div>
    <% end %>
  </div>
</div>

<style>
.calendar-grid {
  background: white;
  border: 1px solid #dee2e6;
  border-radius: 0.25rem;
}

.calendar-header {
  display: grid;
  grid-template-columns: repeat(7, 1fr);
  background: #f8f9fa;
  border-bottom: 2px solid #dee2e6;
}

.calendar-day-header {
  padding: 1rem;
  text-align: center;
  font-weight: bold;
  color: #495057;
}

.calendar-body {
  display: grid;
  grid-template-columns: repeat(7, 1fr);
  gap: 1px;
  background: #dee2e6;
}

.calendar-cell {
  background: white;
  min-height: 120px;
  padding: 0.5rem;
  position: relative;
}

.calendar-cell.other-month {
  background: #f8f9fa;
  opacity: 0.6;
}

.calendar-cell.today {
  background: #fff3cd;
}

.calendar-date-number {
  font-size: 0.875rem;
  font-weight: 600;
  color: #495057;
  margin-bottom: 0.25rem;
}

.calendar-cell.today .calendar-date-number {
  background: #ffc107;
  color: white;
  display: inline-block;
  width: 1.75rem;
  height: 1.75rem;
  line-height: 1.75rem;
  border-radius: 50%;
  text-align: center;
}

.calendar-events {
  display: flex;
  flex-direction: column;
  gap: 0.25rem;
}

.calendar-event-badge {
  padding: 0.25rem 0.5rem;
  border-radius: 0.25rem;
  font-size: 0.75rem;
  cursor: pointer;
  transition: transform 0.2s;
}

.calendar-event-badge:hover {
  transform: translateY(-2px);
  box-shadow: 0 2px 4px rgba(0,0,0,0.2);
}

.event-time {
  font-weight: 600;
  margin-bottom: 0.125rem;
}

.event-title {
  font-size: 0.7rem;
  line-height: 1.2;
}

@media (max-width: 768px) {
  .calendar-day-header {
    padding: 0.5rem 0.25rem;
    font-size: 0.875rem;
  }
  
  .calendar-cell {
    min-height: 80px;
    padding: 0.25rem;
  }
  
  .calendar-event-badge {
    font-size: 0.65rem;
    padding: 0.125rem 0.25rem;
  }
  
  .event-title {
    display: none;
  }
}
</style>

