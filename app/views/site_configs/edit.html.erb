<div class="row">
  <div class="col-lg-8 mx-auto">
    <div class="d-flex justify-content-between align-items-center mb-4">
      <h1>
        <i class="bi bi-gear"></i> Site Configuration
      </h1>
      <%= link_to locations_path, class: "btn btn-outline-primary" do %>
        <i class="bi bi-geo-alt"></i> Manage Locations
      <% end %>
    </div>

    <div class="alert alert-info">
      <i class="bi bi-info-circle"></i> <strong>Note:</strong> These settings control the site-wide appearance and information. Changes apply immediately across the entire site.
    </div>

    <div class="card">
      <div class="card-body">
        <%= form_with(model: @site_config, url: site_config_path, method: :patch, local: true) do |f| %>
          <% if @site_config.errors.any? %>
            <div class="alert alert-danger">
              <h4><%= pluralize(@site_config.errors.count, "error") %> prohibited this configuration from being saved:</h4>
              <ul>
                <% @site_config.errors.full_messages.each do |message| %>
                  <li><%= message %></li>
                <% end %>
              </ul>
            </div>
          <% end %>

          <h5 class="border-bottom pb-2 mb-3">Organization Information</h5>

          <div class="mb-3">
            <%= f.label :organization_name, "Organization Name", class: "form-label" %>
            <%= f.text_field :organization_name, class: "form-control", required: true, placeholder: "My Awesome Hackerspace" %>
            <small class="form-text text-muted">
              This appears in the navigation bar and page titles
            </small>
          </div>

          <div class="mb-3">
            <%= f.label :website_url, "Organization Website", class: "form-label" %>
            <%= f.url_field :website_url, class: "form-control", placeholder: "https://example.org" %>
            <small class="form-text text-muted">
              <i class="bi bi-link-45deg"></i> If set, clicking the organization name will link to this URL
            </small>
          </div>

          <div class="row">
            <div class="col-md-6 mb-3">
              <%= f.label :contact_email, "Contact Email", class: "form-label" %>
              <%= f.email_field :contact_email, class: "form-control", placeholder: "info@hackerspace.org" %>
              <small class="form-text text-muted">
                <i class="bi bi-envelope"></i> Public contact email
              </small>
            </div>

            <div class="col-md-6 mb-3">
              <%= f.label :contact_phone, "Contact Phone", class: "form-label" %>
              <%= f.text_field :contact_phone, class: "form-control", placeholder: "(555) 123-4567" %>
              <small class="form-text text-muted">
                <i class="bi bi-telephone"></i> Public contact phone
              </small>
            </div>
          </div>

          <h5 class="border-bottom pb-2 mb-3 mt-4">Branding</h5>

          <div class="mb-3">
            <%= f.label :favicon, "Favicon", class: "form-label" %>
            <%= f.file_field :favicon, class: "form-control", accept: "image/x-icon,image/png,image/svg+xml" %>
            <small class="form-text text-muted">
              <i class="bi bi-image"></i> Upload a favicon (.ico, .png, or .svg file, recommended 32x32 or 64x64 pixels)
            </small>
            <% if @site_config.favicon.attached? %>
              <div class="mt-2">
                <%= image_tag @site_config.favicon, class: "img-thumbnail", style: "max-width: 64px; max-height: 64px;", alt: "Current site favicon" %>
                <div class="form-check mt-2">
                  <%= f.check_box :remove_favicon, class: "form-check-input" %>
                  <%= f.label :remove_favicon, "Remove current favicon", class: "form-check-label" %>
                </div>
              </div>
            <% end %>
          </div>

          <div class="mb-3">
            <%= f.label :banner_image, "Site Banner", class: "form-label" %>
            <%= f.file_field :banner_image, class: "form-control", accept: "image/*" %>
            <small class="form-text text-muted">
              <i class="bi bi-image"></i> Upload a banner image for the homepage (JPG, PNG, GIF, recommended 1200x400 pixels)
            </small>
            <% if @site_config.banner_image.attached? %>
              <div class="mt-2">
                <%= image_tag @site_config.banner_image, class: "img-thumbnail", style: "max-width: 400px;", alt: "Current site banner image" %>
                <div class="form-check mt-2">
                  <%= f.check_box :remove_banner_image, class: "form-check-input" %>
                  <%= f.label :remove_banner_image, "Remove current banner", class: "form-check-label" %>
                </div>
              </div>
            <% end %>
          </div>

          <h5 class="border-bottom pb-2 mb-3 mt-4">Location Information</h5>

          <div class="mb-3">
            <%= f.label :location_info, "General Location Information", class: "form-label" %>
            <%= f.text_area :location_info, class: "form-control", rows: 4, placeholder: "Tell people about your space, how to find it, parking info, accessibility, etc." %>
            <small class="form-text text-muted">
              <i class="bi bi-info-circle"></i> This appears on the /location page. Include directions, parking, accessibility, etc.
            </small>
          </div>

          <div class="mb-3">
            <%= f.label :address, "Physical Address", class: "form-label" %>
            <%= f.text_field :address, class: "form-control", placeholder: "123 Main St, Portland, OR 97201" %>
            <small class="form-text text-muted">
              <i class="bi bi-pin-map-fill"></i> This will be used to show a Google Map on the /location page
            </small>
          </div>

          <h5 class="border-bottom pb-2 mb-3 mt-4">Integrations</h5>

          <div class="mb-3">
            <div class="form-check">
              <%= f.check_box :slack_enabled, class: "form-check-input" %>
              <%= f.label :slack_enabled, "Enable Slack Notifications", class: "form-check-label" %>
              <div class="form-text">
                <i class="bi bi-slack"></i> When enabled, event reminders are posted to Slack at 9 AM on the day of the event. Requires <code>SLACK_WEBHOOK_URL</code>.
              </div>
            </div>
          </div>

          <div class="mb-3">
            <div class="form-check">
              <%= f.check_box :social_reminders_enabled, class: "form-check-input" %>
              <%= f.label :social_reminders_enabled, "Enable Social Media Reminders", class: "form-check-label" %>
              <div class="form-text">
                <i class="bi bi-share"></i> When enabled, event reminders are posted to Instagram and Bluesky one week and one day before each event at 10 AM. Requires social media credentials in environment variables.
              </div>
            </div>
          </div>

          <div class="mb-3">
            <div class="form-check">
              <%= f.check_box :host_email_reminders_enabled, class: "form-check-input" %>
              <%= f.label :host_email_reminders_enabled, "Enable Host Email Reminders", class: "form-check-label" %>
              <div class="form-text">
                <i class="bi bi-envelope"></i> When enabled, event hosts receive email notifications the day before Slack/social media reminders are posted, allowing them to customize the message. Requires SMTP configuration.
              </div>
            </div>
          </div>

          <div class="mb-3">
            <div class="form-check">
              <%= f.check_box :email_test_mode_enabled, class: "form-check-input", id: "email_test_mode_enabled" %>
              <%= f.label :email_test_mode_enabled, "Email Test Mode", class: "form-check-label" %>
              <div class="form-text">
                <i class="bi bi-bug"></i> When enabled, all host reminder emails are sent to the test address below instead of the actual event hosts. Useful for testing email delivery without notifying real users.
              </div>
            </div>
          </div>

          <div class="mb-3" id="email-test-mode-address-container">
            <%= f.label :email_test_mode_address, "Test Mode Email Address", class: "form-label" %>
            <%= f.email_field :email_test_mode_address, class: "form-control", placeholder: "test@example.com", id: "email_test_mode_address" %>
            <small class="form-text text-muted">
              <i class="bi bi-envelope-at"></i> All host reminder emails will be sent to this address when test mode is enabled.
            </small>
          </div>

          <div class="mb-3">
            <%= f.label :ai_reminder_prompt, "AI reminder prompt", class: "form-label" %>
            <%= f.text_area :ai_reminder_prompt, class: "form-control", rows: 3, placeholder: SiteConfig::DEFAULT_AI_REMINDER_PROMPT %>
            <small class="form-text text-muted">
              Customize the prompt used when "Generate with AI" is clicked. Use {{event_title}}, {{event_date}}, {{event_time}}, and {{event_description}} placeholders; defaults to a friendly reminder mentioning PDX Hackerspace.
            </small>
          </div>

          <div class="mb-3">
            <%= f.label :ai_model, "AI Model", class: "form-label" %>
            <% if OllamaService.configured? && @ollama_models.any? %>
              <%= f.select :ai_model, options_for_select(@ollama_models, @site_config.ai_model), { include_blank: "Select a model..." }, class: "form-select" %>
              <small class="form-text text-muted">
                <i class="bi bi-robot"></i> Select the Ollama model to use for generating AI reminder messages.
              </small>
            <% elsif OllamaService.configured? %>
              <%= f.text_field :ai_model, class: "form-control", placeholder: "e.g. llama2, mistral, gemma" %>
              <small class="form-text text-muted text-warning">
                <i class="bi bi-exclamation-triangle"></i> Could not fetch models from Ollama server. Enter a model name manually.
              </small>
            <% else %>
              <%= f.text_field :ai_model, class: "form-control", disabled: true, placeholder: "Ollama not configured" %>
              <small class="form-text text-muted">
                <i class="bi bi-info-circle"></i> Set <code>OLLAMA_SERVER</code> environment variable to enable AI features.
              </small>
            <% end %>
          </div>

          <div class="row">
            <div class="col-md-6 mb-3">
              <%= f.label :short_reminder_max_length, "Short Reminder Max Length", class: "form-label" %>
              <%= f.number_field :short_reminder_max_length, class: "form-control", min: 100, max: 500 %>
              <small class="form-text text-muted">
                <i class="bi bi-chat-square-text"></i> Maximum characters for short reminders (Bluesky). Default: 300
              </small>
            </div>
            <div class="col-md-6 mb-3">
              <%= f.label :long_reminder_max_length, "Long Reminder Max Length", class: "form-label" %>
              <%= f.number_field :long_reminder_max_length, class: "form-control", min: 200, max: 2000 %>
              <small class="form-text text-muted">
                <i class="bi bi-chat-text"></i> Maximum characters for long reminders (Slack/Instagram). Default: 800
              </small>
            </div>
          </div>

          <h5 class="border-bottom pb-2 mb-3 mt-4">
            <i class="bi bi-graph-up"></i> Analytics (Matomo)
          </h5>

          <div class="mb-3">
            <div class="form-check form-switch">
              <%= f.check_box :matomo_enabled, class: "form-check-input", role: "switch", id: "matomo_enabled" %>
              <%= f.label :matomo_enabled, "Enable Matomo Analytics", class: "form-check-label" %>
            </div>
            <small class="form-text text-muted">
              <i class="bi bi-info-circle"></i> When enabled, Matomo tracking code will be added to all pages
            </small>
          </div>

          <div class="row" id="matomo-settings">
            <div class="col-md-8 mb-3">
              <%= f.label :matomo_url, "Matomo Server URL", class: "form-label" %>
              <%= f.url_field :matomo_url, class: "form-control", placeholder: "https://analytics.example.org" %>
              <small class="form-text text-muted">
                The URL of your Matomo instance (without trailing slash)
              </small>
            </div>

            <div class="col-md-4 mb-3">
              <%= f.label :matomo_site_id, "Site ID", class: "form-label" %>
              <%= f.text_field :matomo_site_id, class: "form-control", placeholder: "1" %>
              <small class="form-text text-muted">
                Your Matomo site ID number
              </small>
            </div>
          </div>

          <h5 class="border-bottom pb-2 mb-3 mt-4">
            <i class="bi bi-shield-exclamation"></i> SEO & Indexing
          </h5>

          <div class="mb-3">
            <div class="form-check form-switch">
              <%= f.check_box :disallow_robots, class: "form-check-input", role: "switch", id: "disallow_robots" %>
              <%= f.label :disallow_robots, "Disallow Search Engine Robots", class: "form-check-label" %>
            </div>
            <small class="form-text text-muted">
              <i class="bi bi-exclamation-triangle text-warning"></i>
              <strong>Development servers only.</strong> When enabled, robots.txt will block all crawlers, 
              and pages will include noindex/nofollow meta tags. Use this to prevent development or staging 
              servers from being accidentally indexed by search engines.
            </small>
          </div>

          <h5 class="border-bottom pb-2 mb-3 mt-4">Footer</h5>

          <div class="mb-3">
            <%= f.label :footer_text, "Footer Text", class: "form-label" %>
            <%= f.text_area :footer_text, class: "form-control", rows: 3, placeholder: "© 2025 My Hackerspace - All Rights Reserved" %>
            <small class="form-text text-muted">
              This appears at the bottom of every page. Leave blank for default.
            </small>
          </div>

          <div class="mt-4">
            <%= f.submit "Save Configuration", class: "btn btn-primary" %>
            <%= link_to "Cancel", root_path, class: "btn btn-secondary" %>
          </div>
        <% end %>
      </div>
    </div>

    <div class="card mt-4">
      <div class="card-body">
        <h5 class="card-title">Preview</h5>
        <p class="text-muted">This is how your configuration will appear:</p>
        
        <div class="border rounded p-3 bg-light">
          <% if @site_config.banner_image.attached? %>
            <div class="mb-3">
              <%= image_tag @site_config.banner_image, class: "img-fluid rounded", style: "max-height: 200px;", alt: "Site banner preview for #{@site_config.organization_name || 'EventManager'}" %>
            </div>
          <% end %>
          
          <h4>
            <%= @site_config.organization_name || 'EventManager' %>
            <% if @site_config.website_url.present? %>
              <small class="text-muted">→ <i class="bi bi-link-45deg"></i> <%= @site_config.website_url %></small>
            <% end %>
          </h4>
          
          <% if @site_config.contact_email.present? || @site_config.contact_phone.present? %>
            <p class="mb-1">
              <% if @site_config.contact_email.present? %>
                <i class="bi bi-envelope"></i> <%= @site_config.contact_email %>
              <% end %>
              <% if @site_config.contact_phone.present? %>
                <br><i class="bi bi-telephone"></i> <%= @site_config.contact_phone %>
              <% end %>
            </p>
          <% end %>
          
          <hr>
          
          <footer class="text-center text-muted">
            <small><%= @site_config.footer_text.presence || "© #{Time.current.year} EventManager - Hackerspace Event Management System" %></small>
          </footer>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
  document.addEventListener('DOMContentLoaded', function() {
    const testModeCheckbox = document.getElementById('email_test_mode_enabled');
    const testModeAddressContainer = document.getElementById('email-test-mode-address-container');
    const testModeAddressField = document.getElementById('email_test_mode_address');

    function toggleTestModeAddress() {
      if (testModeCheckbox.checked) {
        testModeAddressContainer.style.opacity = '1';
        testModeAddressField.disabled = false;
      } else {
        testModeAddressContainer.style.opacity = '0.5';
        testModeAddressField.disabled = true;
      }
    }

    // Set initial state
    toggleTestModeAddress();

    // Listen for changes
    testModeCheckbox.addEventListener('change', toggleTestModeAddress);
  });
</script>

