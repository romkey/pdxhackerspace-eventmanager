<%# Display posting history for an event - for hosts and admins %>
<% postings = event.reminder_postings.includes(:event_occurrence, :deleted_by).recent_first %>

<% if postings.any? %>
  <section class="card mb-3">
    <div class="card-body">
      <h2 class="card-title h5">
        <i class="bi bi-clock-history"></i> Reminder Posting History
      </h2>
      <p class="card-text small text-muted">
        Social media and Slack reminders posted for this event
      </p>

      <div class="accordion accordion-flush" id="postingsAccordion">
        <% postings.limit(10).each_with_index do |posting, index| %>
          <div class="accordion-item">
            <h2 class="accordion-header">
              <button class="accordion-button collapsed py-2" type="button" 
                      data-bs-toggle="collapse" 
                      data-bs-target="#posting<%= posting.id %>" 
                      aria-expanded="false">
                <span class="d-flex align-items-center gap-2 flex-wrap">
                  <%= render_platform_badge(posting.platform) %>
                  <small class="text-muted"><%= posting.posted_at.strftime('%b %d, %Y %I:%M %p') %></small>
                  <% if posting.event_occurrence %>
                    <small class="text-muted">
                      â†’ <%= posting.event_occurrence.occurs_at.strftime('%b %d') %>
                    </small>
                  <% end %>
                  <% if posting.deleted? %>
                    <span class="badge bg-secondary"><i class="bi bi-trash"></i> Deleted</span>
                  <% end %>
                </span>
              </button>
            </h2>
            <div id="posting<%= posting.id %>" class="accordion-collapse collapse">
              <div class="accordion-body pt-2 pb-3">
                <p class="mb-2" style="white-space: pre-wrap;"><%= posting.message %></p>
                <div class="d-flex justify-content-between align-items-center">
                  <small class="text-muted">
                    <% if posting.deleted? %>
                      Deleted by <%= posting.deleted_by&.name || 'Unknown' %> on <%= posting.deleted_at.strftime('%b %d, %Y') %>
                    <% end %>
                  </small>
                  <% unless posting.deleted? %>
                    <div class="btn-group btn-group-sm">
                      <% if posting.post_url.present? %>
                        <%= link_to posting.post_url, target: "_blank", rel: "noopener", 
                            class: "btn btn-outline-primary btn-sm", title: "View" do %>
                          <i class="bi bi-box-arrow-up-right"></i> View
                        <% end %>
                      <% end %>
                      <% if posting.deletable? %>
                        <%= button_to reminder_posting_path(posting), method: :delete, 
                            class: "btn btn-outline-danger btn-sm",
                            title: "Delete from #{posting.platform_display_name}",
                            form: { data: { turbo_confirm: "Delete this post from #{posting.platform_display_name}?" } } do %>
                          <i class="bi bi-trash"></i> Delete
                        <% end %>
                      <% else %>
                        <%= button_to reminder_posting_path(posting), method: :delete, 
                            class: "btn btn-outline-warning btn-sm",
                            title: "Mark as deleted",
                            form: { data: { turbo_confirm: "Mark this post as deleted?" } } do %>
                          <i class="bi bi-x-circle"></i> Remove
                        <% end %>
                      <% end %>
                    </div>
                  <% end %>
                </div>
              </div>
            </div>
          </div>
        <% end %>
      </div>

      <% if postings.count > 10 %>
        <p class="small text-muted mb-0 mt-2">
          Showing 10 of <%= postings.count %> postings.
          <% if current_user.admin? %>
            <%= link_to "View all postings", reminder_postings_path %>
          <% end %>
        </p>
      <% end %>
    </div>
  </section>
<% end %>
